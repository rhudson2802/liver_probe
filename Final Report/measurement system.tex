\section{Measurement System}
\subsection{Hardware}

\begin{figure}[htbp]
	\centering
	\includegraphics[width=\linewidth]{measurement.PNG}
	\caption{Circuit schematic of diffuse reflectance measurement system.}
	\label{fig: measurement schematic}
\end{figure}

Figure \ref{fig: measurement schematic} illustrates the circuit used to perform the backscatter measurements on the liver. Fundamentally, this circuit shines an LED at the liver, then produces an output voltage proportional to the amount of light reflected back. The clinical trials of the original probe \cite{Robertson} used two LEDs, one with a red wavelength (\SI{660}{\nano\metre}) and one with an infra-red wavelength (\SI{850}{\nano\metre}). Two photodiodes were also used, so over all 4 different measurements could be made (with each photodiode-LED combination). The results showed that the correlation with liver PNF did not depend on the wavelength or LED-photodiode spacing, so this was not a critical design requirement of the new probe. Therefore, an LED in the near infra-red (NIR) range was selected (Vishay TSHA4401 \cite{tsha4401} \SI{875}{\nano\metre}) along with a phototransistor also in the NIR range (Vishay BPW85B \cite{bpw85b} \SI{850}{\nano\metre}).\\

The left hand side circuit of figure \ref{fig: measurement schematic} provides a constant current to the LED. This is essential to ensure the measurements are repeatable, as the brightness of an LED is proportional to its current. The operation of the circuit will now be discussed. First consider the case where MOSFET Q1 has its gate driven low, so it is off. This means that negligible current will flow through the MOSFET, so the op-amp U1A has \SI{2.5}{\volt} at its non-inverting input. Assuming the op-amp is ideal (which means it has infinite gain and input impedance, and zero output impedance), the voltage at the inverting input will also be \SI{2.5}{\volt}. This means there is a constant \SI{2.5}{\volt} across R2, so it draws a constant \SI{11.4}{\milli\ampere}. Because the op-amp is assumed to be ideal, no current can go into the input pins, so the full \SI{11.4}{\milli\ampere} must be sourced from the op-amp output pin and hence pass through the LED D5. This creates a constant current source for the LED, assuming a constant \SI{2.5}{\volt} rail and that the ideal op-amp assumption is valid. When the MOSFET gate is driven high it turns on. This leads to the MOSFET having a very low impedance, so the non-inverting input is effectively tied to ground. Therefore R2 has no volts across it, and hence no current, so the LED turns off.\\

The MCP6002-I/SN \cite{mcp6002} was selected as the op-amp. This has a short circuit output current of \SI{23}{\milli\ampere}, so will comfortably be able to provide the desired \SI{11.4}{\milli\ampere}. Its input offset voltage is $\pm\SI{4.5}{\milli\volt}$, which leads to a potential current error of \SI{20}{\micro\ampere} (or 0.17\%), which is a negligible error. The input voltage noise density is \SI{28}{\nano\volt\per\sqrt{\hertz}} and the gain-bandwidth product is \SI{1}{\mega\hertz} so the worst case bandwidth is \SI{1}{\mega\hertz} (which assumes unity gain). This leads to an input noise voltage of \SI{28}{\micro\volt}, which again is negligible. The current source was tested for its invariance to temperature. When exposed to the heat fro ma hairdryer, the LED current only changed by 0.85\%, so there is confidence that the current source will be stable over the operating temperatures.\\

The light transmitted by the LED is then reflected off the target liver, and the received light is collected by phototransistor Q2. This produces a current proportional to the input light power. A transimpedance amplifier is used convert this to a readable voltage signal. Again assuming op-amp U1B is ideal implies that the voltage at the input pins are equal, and no current enters the pins. The phototransistor current $i_f$ therefore passes through the resistor R3, which leads to an output voltage signal $v_0 = 2.5 - i_fR_f$. The \SI{2.5}{\volt} rail at the non-inverting input acts to bias the op-amp, and was selected as half the voltage rails to ensure that the op-amp output signal could have maximum voltage swing before clipping at the supply rails.\\

\begin{table}[htbp]
	\centering
	\caption{Results for feedback resistor calibration experiments. The peak to peak signal is the difference between the output voltage when the LED was on and off, and the minimum signal is the output voltage when the LED was on.}
	\label{tab: tia feedback resistor}
	\begin{tabular}{|c|c|c|c|}
		\hline
		\textbf{LED Current} & \textbf{Feedback Resistor} & \textbf{Peak to Peak Signal} & \textbf{Minimum Signal}\\
		(mA)	&	(\si{\kilo\ohm})	&	(V)	&	(V)\\
		\hline
		\multirow{4}{*}{10}	&	2.2	&	0.93	&	1.20\\
						\cline{2-4}
						&	3.3	&	1.20	&	1.06\\
						\cline{2-4}
						&	4.7	&	1.60	&	0.62\\
						\cline{2-4}
						&	6.8	&	2.22	&	0.00\\
		\hline
		\multirow{4}{*}{20}	&	1.2	&	0.84	&	1.42\\
						\cline{2-4}
						&	1.5	&	1.07	&	1.15\\
						\cline{2-4}
						&	2.7	&	1.9	&	0.25\\
						\cline{2-4}
						&	3.3	&	2.09	&	0.00\\
		\hline
	\end{tabular}
\end{table}

The feedback resistor $R_f$ needed to be chosen to ensure good output characteristics. If it was too small, then the PIC's ADC would not be able to discriminate between changes in the light intensity.  The PIC16F688 uses a 10-bit ADC, so the maximum voltage resolution is \SI{4.88}{\milli\volt} when operated at \SI{5}{\volt}. The feedback resistor also cannot be too large, as this could lead to the op-amp saturating at the ground supply rail. Table \ref{tab: tia feedback resistor} shows the results of an experiment carried out to investigate the signal levels with different feedback resistors. The circuit was constructed on breadboard, with the LED and phototransistor soldered to stripboard to ensure they remained at a fixed distance of \SI{7.62}{\milli\metre}. This was then shone at a piece of A4 paper at a distance which led to the largest signal. The peak to peak signal is the difference between the transimpedance amplifier output voltage when the LED was on and off, and the minimum signal is the output voltage when the LED was on. Whenever the minimum signal was \SI{0}{\volt}, the amplifier had saturated so these values of $R_f$ are unsuitable. Therefore, the optimum $R_f = \SI{4.7}{\kilo\ohm}$, as this had the largest peak to peak signal without saturating. The system was tested using an LED current of \SI{20}{\milli\ampere} as well, but it was decided that this was too close to the op-amp output current limit to be a reliable, stable current source.\\

%LTSpice simulation

The transimpedance amplifier is a notoriously unstable circuit due to the phototransistor's junction capacitance. This can be stabilised by adding the capacitor C1 \cite{tia_stability}, which adds a zero into the feedback factor, compensating for the pole created by the phototransistor capacitance \cite{tia_stability}. The capacitor value was selected to be \SI{470}{\pico\farad}, as this gave a bandwidth of \SI{72}{\kilo\hertz} which is well above the required bandwidth of the circuit (which is \SI{10}{\kilo\hertz} at most), but is well below the gain-bandwidth product of \SI{1}{\mega\hertz} so it avoids the stability problems.\\

A button also needed to be designed for the probe, so the surgeon could indicate that they wanted to take a measurement. A standard push button could not be used because the remote unit had to be hermetically sealed. Therefore, a non-contact means of sensing a button press had to be devised. This could either be capacitive, sensing the finger like the touch screen on a mobile phone, or optical, by measuring light reflected back from the finger. It was found that the liver backscatter measurement system (figure \ref{fig: measurement schematic}) was discriminated well between the presence or absence of a finger at a range of a few centimetres, so this circuit was included twice within the remote unit to be used as a button. The downside to this method is that it is an active sensing system, requiring power to be supplied to the LED and phototransistor. This will limit the time the remote unit can operate over one full charge. \\

\begin{figure}[htbp]
	\centering
	\includegraphics[width=0.4\linewidth]{2-5v rail.PNG}
	\caption{Op-amp unity buffer used to generate \SI{2.5}{\volt} rail.}
	\label{fig: 2.5v rail}
\end{figure}

The measurement system used a \SI{2.5}{\volt} reference rail. This rail had to be stable as it provided the reference signal for the LED current source and transimpedance amplifier, so any variations in the \SI{2.5}{\volt} signal would lead to measurement errors. An op-amp unity buffer circuit (figure \ref{fig: 2.5v rail}) was used to generate this signal from a potential divider reference. This is more stable than directly using a potential divider, as any loading of the potential divider will decrease the reference voltage it provides. Because an op-amp draws negligible current, the resulting output voltage will be much more stable. The output will only remain stable the circuits it is connected to do not draw more than the op-amp's rated output current. The \SI{2.5}{\volt} rail is only used to supply current to a \SI{10}{\kilo\ohm} resistor (\SI{250}{\micro\ampere}) and op-amp input (negligible current), so the op-amp will not have to provide significant current. Additionally, the output will only be a fixed \SI{2.5}{\volt} reference if the \SI{5}{\volt} supply also remains stable, which is ensured by using a voltage regulator (see section \ref{power}).\\




\subsection{Firmware}
The system would give different readings depending on the background lighting conditions, as these would appear as an offset in the phototransistor current. To add resilience to background light, each measurement was the difference between the phototransistor reading when the LED was on (which gives information about the target liver and the background light) and the reading when the LED was off (which gives information about the background light). Assuming the phototransistor has a linear incident light intensity-current response, this difference will leave just the information about the liver with no dependence on background light. A series of readings was made (N=50) and the average taken, to further increase the resilience to noise. The PICBASIC code is given below.
\begin{lstlisting}
ir_led var PORTC.2
red_led var PORTC.0
phototransistor con 7       '' Analogue port used as input

reading var word
dark var word
light var word
N var byte
i var byte

mainloop:
reading = 0
dark = 0
light = 0

low red_led

for i = 1 to N
    low ir_led
    pause 1
    adcin phototransistor, light      '' read in light data
    high ir_led
    pause 1
    adcin phototransistor, dark      '' read in dark data
    
    '' Add current readings to sum
    '' Dark should be > light if measurement variation is due to our probe
    if dark >= light then
        reading = reading + (dark - light)
    else
        reading = 0
    endif
next i  

'' Compute mean
reading = reading / N

goto mainloop
\end{lstlisting}






\subsection{Testing}
\begin{figure}[htbp]
	\centering
	\includegraphics[width=0.8\linewidth]{old probe comparison.png}
	\caption{Comparison of old and new probe readings when aimed at a sheet of A4 paper, at a separation of 1, 2, 3, 4 and 5 cm. The red line indicates the boundary between high- and low-fat livers measured by the old probe in clinical trials. Plotted on a log-log scale.}
	\label{fig: old probe comparison}
\end{figure}

The measurement system was first tested to measure the correlation between readings taken with the old probe and those taken with the new design. This was important, because the new design's readings need to be highly correlated with the old probe to ensure that the new probe will have the same predictive power in clinical trials. The probes give an output in arbitrary units which is simply the ADC output of the PIC. These are arbitrary units, and will be different for the two designs due to different component selection and circuit design. The two probes had their correlation tested by measuring the output at fixed distances from a sheet of A4 paper. This will give different intensities of backscattered light, so can be used for calibration. Figure \ref{fig: old probe comparison} shows the outcome of this experiment. The R\textsuperscript{2} correlation coefficient is 0.9859, so the probes are highly correlated as desired. \\

\begin{figure}[htbp]
	\centering
	\includegraphics[width=0.8\linewidth]{liquids.png}
	\caption{Measurements made by the probe on different liquids, with a liquid depth of \SI{2}{\centi\metre} and probe range of \SI{3}{\centi\metre}.}
	\label{fig: liquids}
\end{figure}

The measurement system was then tested to determine its response to lipid concentration. Readings were taken from shining the probe at water, semi-skimmed milk (2\% fat), and full-fat milk (4\% fat). The milk will have suspended lipid droplets which can be used as a proof-of-concept to model probe's response to fat concentration. It will also include other biological molecules such as proteins. Figure \ref{fig: liquids} shows that the probe reading does increase for the liquids with higher fat concentration.






