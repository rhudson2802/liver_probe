\section{Wireless Charging and Power}\label{power}

\subsection{Hardware}

The remote unit was designed to run from a \SI{5}{\volt} supply. \SI{3.3}{\volt} was not suitable as the LEDs had a forward voltage of \SI{1.5}{\volt}, so a \SI{3.3}{\volt} supply would potentially be too small for the current source depicted in figure \ref{fig: measurement schematic}. A set of batteries had to be selected which would provide this voltage. The batteries had to be small to ensure the overall remote unit design was small enough to fit in the surgeon's hand, and needed to be rechargeable because of the hermetic seal. Two different chemistries were available from RS Components \cite{rs} in a small, rechargeable package: Lithium ion (Li-ion) and Nickel Metal Hydride (NiMH). The NiMH chemistry was more suitable due to the increased safety. Li-ion batteries are highly sensitive to over/under-voltage and high temperatures, and can blow up if these limits are exceeded \cite{batteries}. This requires complex protection circuitry, and the battery may not survive being placed in an autoclave. NiMH batteries are much more resilient to over- and under-charging, so are much safer than Li-ion. A \SI{2.4}{\volt} 80 mAh RS-Pro NiMH button cell \cite{rs_pro_batteries} was suitable. Three of these were used to give a nominal \SI{7.2}{\volt} supply, which gave a margin of 44\% for when the cells started to discharge.\\

%The remote unit was designed to run from a \SI{5}{\volt} supply. \SI{3.3}{\volt} was not suitable as the LEDs had a forward voltage of \SI{1.5}{\volt}, so a \SI{3.3}{\volt} supply would potentially be too small for the current source designed in figure \ref{fig: measurement schematic}. A set of batteries had to be selected which would provide this voltage. The batteries had to be small to ensure the overall remote unit design was small enough to fit in the surgeon's hand, and needed to be rechargeable because of the hermetic seal. Two different chemistries were available from RS Components \cite{rs} in a small, rechargeable package: lithium ion (Li-ion) and Nickel Metal Hydride (NiMH). The NiMH chemistry was more suitable due to the increased safety. Li-ion batteries are highly sensitive to over/under-voltage and high temperatures, and can blow up if these limits are exceeded \cite{batteries}. This requires complex protection circuitry and may mean that the battery will not survive being placed in an autoclave. NiMH are much more resilient to over and under charging, so are much safer than Li-ion. They also have a higher energy density \cite{batteries}. Nevertheless, they are lower voltage so more cells will be required to provide the desired \SI{5}{\volt}, have a long charging time, and they have a high self-discharge rate \cite{batteries}. This is not such an issue for this application, as the remote unit can remain charging until it is required for an operation, and then it will only be used for a short time before being placed on charge again. A \SI{2.4}{\volt} \SI{80}{\milli\ampere\hour} RS-Pro NiMH button cell \cite{rs_pro_batteries} was suitable. Three of these were used to give a nominal \SI{7.2}{\volt} supply, which gave a margin of 44\% for when the cells started to discharge.\\
%Cut?

A power converter was then selected to drop the \SI{7.2}{\volt} battery voltage to the required \SI{5}{\volt} rail. A Low-Dropout (LDO) voltage regulator was deemed suitable for this application, as it would provide a stable voltage rail. The advantage over a buck converter is the smaller device size and design simplicity, but this comes at the cost of worse efficiency. Furthermore, the output voltage will not have the high-frequency ripple associated with switch-mode converters, which is desirable to create a stable analogue rail to ensure that there are no measurement errors. The MCP1702T-5002E/CB \cite{mcp1702} in a SOT-23A package was suitable. This was a \SI{5}{\volt} regulator with a rated output current of \SI{250}{\milli\ampere}. This was well above the \SI{50}{\milli\ampere} maximum current required by the remote unit (see section \ref{power budget}). The quiescent current was \SI{2}{\micro\ampere}, which is negligible compared with the remainder of the circuit, so the regulator will not affect the battery lifetime. The regulator will dissipate a maximum of $(\SI{7.2}{\volt}-\SI{5}{\volt})\times\SI{50}{\milli\ampere}=\SI{110}{\milli\watt}$. The SOT-23A package has a junction-to-air thermal resistance of \SI{336}{\celsius\per\watt}, so the maximum temperature increase is \SI{37}{\celsius}.\\


	

Inductive charging was an appropriate method to recharge the batteries. This involved placing two air-cored coils in close proximity, applying an AC voltage to the primary, and rectifying the voltage across the secondary. This is a similar design to that used in other hermetically sealed low-power products, such as an electric toothbrush charger \cite{wireless_power_review}. Figure \ref{fig: charger schematic} shows the circuit schematic, which uses two PMOS and NMOS pairs in a H-bridge arrangement to generate the AC voltage. The two half bridges were driven with inverted signals, so the voltage across the load alternated between \SI{\pm 5}{\volt}. The series capacitor was used to create a resonant circuit with the inductor, which increased the voltage across the primary coil and smoothed the input square wave to a sinusoid across the inductor. The capacitor was designed to give the circuit a resonant frequency equal to the drive frequency to get the maximum gain possible. The series resistor was included to limit the current through the circuit. An ideal series LC circuit has zero impedance at resonance, so it looks like a short circuit to the external circuit. The PMOS transistors had a current rating of \SI{230}{\milli\ampere}, so a series resistance of \SI{22}{\ohm} limited the current to \SI{227}{\milli\ampere}.\\

\begin{figure}[htb]
	\centering
	\includegraphics[width=\linewidth]{h bridge charger.PNG}
	\caption{Circuit schematic for the H-Bridge inductive wireless charger. The left-hand side circuit is included in the base unit, and the right-hand side circuit is included in the remote unit.}
	\label{fig: charger schematic}
\end{figure}

The primary coil generated an alternating magnetic field due to the sinusoidal voltage across it. This coupled with the secondary coil to induce an alternating voltage. The coupling of air-cored transformers is very poor, so a large voltage was required across the primary coil to ensure the secondary coil received enough volts. The resonant circuit aided this. The alternating voltage across the secondary was then rectified to a DC voltage by a diode bridge. The NSR05F20NXT5G Schottky barrier diode \cite{original_diode} was used in the diode bridge. These were chosen because of their very low forward voltage of \SI{0.2}{\volt}, which made sure that the required secondary voltage was kept as small as possible. Their reverse leakage was \SI{2}{\micro\ampere}, which was also good. They were rated to \SI{20}{\volt} and \SI{500}{\milli\ampere}, which was well below the expected operating conditions of \SI{10}{\volt} and \SI{10}{\milli\ampere}. The battery voltage was \SI{7.2}{\volt}, so the total required voltage across the secondary, including the two diode drops, was \SI{7.6}{\volt}.\\



There are many empirical laws for the inductance of coils. Wheeler's formula \cite{Wheeler} for circular planar coils is:
\begin{equation}\label{eq: solenoid}
L (\si{\micro\henry})= \frac{r^2N^2}{8r + 11d}
\end{equation}
where $N$ is the number of turns, $r$ is the average coil radius in inches, and $d$ is the coil depth in inches. The circular coils constructed for the wireless charger had an inner diameter of \SI{5}{\centi\metre} and an average depth of \SI{0.5}{\centi\metre} (this varied depending on the number of turns). Substituting these geometry parameters into equation \ref{eq: solenoid} implies that $L=\num{9.65e-8}N^2$. The coil inductance was then experimentally determined by measuring the resonant frequency of an LC circuit with known capacitance. The frequency of the input signal was varied until the maximum output voltage across a parallel LC tank was measured. The inductance followed a quadratic dependence on the number of turns (see figure \ref{fig: coil inductance}), as is to be expected from equation \ref{eq: solenoid}. The coefficient is \num{6e-8}, which gives reasonable agreement to the prediction from equation \ref{eq: solenoid}. Equation \ref{eq: solenoid} performs better at small numbers of turns, which could be because it assumes a coil with a single layer of turns, so as more turns are added, the coil geometry transitions from being planar to being toroidal. Furthermore, the construction of the coils meant that there was not a uniform distribution of the coil turns, which could also influence the measured inductance.\\

\begin{figure}[htb]
	\centering
	\includegraphics[width=0.8\linewidth]{coil inductance.png}
	\caption{Coil inductance for different numbers of coil turns.}
	\label{fig: coil inductance}
\end{figure}

\begin{figure}[htb]
	\centering
	\includegraphics[width=0.3\linewidth]{coil experiment.png}
	\caption{Setup for the coil experiments.}
	\label{fig: coil experiment setup}
\end{figure}


The performance of the proposed charging circuit was investigated. First, the coupling of the coils was determined as a function of the coil separation. The experiment was performed using two planar circular coils which were centred on the same out-of-plane axis. Figure \ref{fig: coil experiment setup} illustrates the experiment setup. The primary coil was driven by the H-bridge circuit in figure \ref{fig: charger schematic}, and the secondary coil had its open circuit voltage measured. A capacitor was used to make the system resonant at \SI{100}{\kilo\hertz}, using the equation:
\begin{equation}
C = \frac{1}{(2\pi f_\text{res})^2L}
\end{equation}
If the transformer were ideal, the secondary coil voltage would be $V_2 = V_1 \times N_2 / N_1$, where $V_1$ is the voltage across the primary coil, and $N_2 / N_1$ is the secondary to primary turns ratio. To account for the poor coupling in an air-cored transformer, a coupling coefficient $k$ is introduced, so $V_2 = k \times V_1 \times N_2 / N_1$. The reduction in coupling is because the air-core has a low permeability, so the flux from the primary is not strongly linked to the secondary, leading to a large leakage flux. The experiment was repeated for different turns ratios, all giving similar values of the coupling coefficient. The experimentally determined coupling coefficients are plotted in figure \ref{fig: circular coupling}, which shows a coupling coefficient of 0.28 at a separation of \SI{10}{\milli\metre}.\\

\begin{figure}[htb]
	\centering
	\includegraphics[width=\linewidth]{v2 circular coupling.PNG}
	\caption{Measured coupling coefficient of circular coils as a function of coil separation.}
	\label{fig: circular coupling}
\end{figure}

\begin{figure}[htb]
	\centering
	\includegraphics[width=0.6\linewidth]{charger simulation.PNG}
	\caption{LTspice simulation of the charger circuit.}
	\label{fig: charger simulation}
\end{figure}

The circuit was simulated in LTspice \cite{ltspice}, with the simulation schematic shown in figure \ref{fig: charger simulation}. A voltage source with series resistance was used to model the H-bridge output. The circuit was tested on breadboard, so the surface mount NSR05F20NXT5G diodes could not be used. Instead, a through-hole diode was selected for testing purposes (Vishay UF4001-E3/54 \cite{tht_diode}), which was modelled in the LTspice simulation, so the results could be compared with the experimental results. The coupling between the coils was set to 0.28 to model \SI{10}{\milli\metre} coil separation. The inductors and batteries had an equivalent series resistance modelled additionally. The simulation suggested that the primary coil should have an RMS voltage of \SI{44.4}{\volt}, and the secondary coil should have an RMS voltage of \SI{8.24}{\volt}. This led to an average battery charging current of \SI{13.1}{\milli\ampere}, which was suitable to recharge the remote unit. \\

\begin{table}[htb]
	\begin{center}
	\caption{Current measurements (in milliamps) across a 7.2V battery load for various combinations of primary and secondary coil (with the coils touching).}
	\label{tab: coil combinations}
	\begin{tabular}{|l|*{4}{c|}}
		\hline
		\backslashbox{\textbf{Primary Turns}}{\textbf{Secondary Turns}} & \textbf{50} & \textbf{100} & \textbf{160} & \textbf{200} \\
		\hline
		\textbf{50} & - & 3.97 & 5.32 & 3.32 \\
		\hline
		\textbf{100} & 4.46 & - & 5.22 & 4.75 \\
		\hline
		\textbf{160} & 3.95 & 4.15 & - & 3\\
		\hline
	\end{tabular}
	\end{center}
\end{table}

The charger was tested to see the effect of changing the number of turns in the primary and secondary coils (see table \ref{tab: coil combinations}). The best combinations of primary and secondary coils were the 50/160 and 100/160 combinations. The maximum charging current was \SI{5}{\milli\ampere} when the coils were touching, which is much less than the simulated value at \SI{10}{\milli\metre} separation. At \SI{10}{\milli\metre} separation, the charger could only deliver around \SI{0.5}{\milli\ampere}. This could be because of the presence of parasitic elements within the circuit damping the resonance and reducing the magnitude of the currents. \\ 



The initial tests indicated that the charger would not deliver sufficient current to charge the batteries quickly, as the recommended current to charge the batteries in 16 hours was \SI{8}{\milli\ampere} \cite{rs_pro_batteries}. Therefore, the supply voltage was stepped up to \SI{12}{\volt}, as this would lead to a larger voltage at the secondary side, so a greater current would flow. The circuit in figure \ref{fig: charger schematic} needed to be adapted to the \SI{12}{\volt} supply. A gate driver needed to be designed for the PMOS to provide it with a \SI{12}{\volt} gate signal rather than the \SI{5}{\volt} signal the PIC generates. Because the PMOS gate voltage is referred to the \SI{12}{\volt} rail, if a \SI{5}{\volt} signal were applied to the gate then the PMOS would remain on, as the gate-source voltage (\SI{7}{\volt}) would be greater than the threshold voltage. This would result in a large shoot-through current when the corresponding NMOS is on, as it would look like a short to ground. This would damage the MOSFETs and the supply, as well as not allowing the charger to operate properly. \\

\begin{figure}[htb]
	\centering
	\includegraphics[width=0.7\linewidth]{mcp1407.PNG}
	\caption{Schematic of MCP1406/07 MOSFET driver internal circuitry \cite{mcp1407}.}
	\label{fig: mcp1407}
\end{figure}

To avoid this problem, two MOSFET driver ICs (Microchip's MCP1406 and MCP1407 \cite{mcp1407}) were selected to replace the H-bridge. These ICs are designed to drive the gate of a power MOSFET, but are also suitable for this application because they supply a large current (up to \SI{6}{\ampere}) and a large voltage (up to \SI{18}{\volt}). Figure \ref{fig: mcp1407} demonstrates that the internal circuitry of the MCP1406/07 takes an input CMOS/TTL signal and uses this to control a push-pull CMOS inverter. Therefore, the H-bridge MOSFETs can be replaced by these ICs, as they take care of the gate drive. The drivers come in two varieties: the inverting MCP1406 and the non-inverting MCP1407. Choosing one of each (for the different sides of the H-bridge) means only one input signal is required from the PIC, freeing up an I/O pin for other uses. The propagation times for both devices are the same (\SI{40}{\nano\second}), so there is no risk of dangerous shoot-through currents, assuming they are placed close enough together on the PCB so that the delay time in the PCB traces is negligible.\\



The schematic for the primary side is shown in figure \ref{fig: mosfet drivers charger}. Three capacitors were included so the resonant circuit could be finely tuned. A \SI{22}{\ohm} resistor was used to limit the current to \SI{500}{\milli\ampere}, as this was the maximum current the power supply could provide. The circuit provided \SI{2.5}{\milli\ampere} of charging current to the three \SI{2.4}{\volt} batteries when tested on breadboard with the coils separated by \SI{10}{\milli\metre}. This was reflective of the real-life conditions, and the \SI{2.5}{\milli\ampere} charging current would fully charge the 80 mAh batteries in \SI{32}{\hour}. The batteries' recommended charging current is \SI{8}{\milli\ampere}, so while the current is a little low, this will not be a large problem as it is expected that the remote unit will be left on constant charge.\\

\begin{figure}[htb]
	\centering
	\includegraphics[width=0.8\linewidth]{mosfet drivers charger.PNG}
	\caption{Primary side of the charging circuit using the MCP1406/07 MOSFET drivers.}
	\label{fig: mosfet drivers charger}
\end{figure}
~\\
Using the \SI{12}{\volt} supply voltage resulted in \SI{112}{\volt} across the primary coil and \SI{51}{\volt} across the secondary (under open circuit conditions with \SI{10}{\milli\metre} separation). This was greater than the NSR05F20NXT5G voltage rating of \SI{20}{\volt}, so new diodes were selected for the bridge rectifier to handle the higher voltage. The NXP PMEG10020ELRX Schottky barrier diode \cite{new_diode} was rated to \SI{100}{\volt} and \SI{2}{\ampere}, so was suitable for the application. It had a low forward voltage of \SI{0.4}{\volt} and a reverse leakage current of \SI{10}{\nano\ampere} at \SI{25}{\celsius}, which will lead to good performance.\\




\begin{figure}[htb]
	\centering
	\includegraphics[width=0.6\linewidth]{battery current sensor.PNG}
	\caption{Battery current sensor.}
	\label{fig: battery current sensor}
\end{figure}

A current sensor was included to measure the remote unit charging and discharging currents. A \SI{1}{\ohm} resistor (R2 in figure \ref{fig: charger schematic}) was placed in series with the batteries to develop a voltage proportional to the current through the batteries. R2 was placed between BT2 and BT3 so it sat at \SI{2.4}{\volt}, as it was important to ensure that the voltage input to the amplifier was not close to the amplifier supply rails, as this would result in clipping. The voltage across R2 was used as the input to a differential amplifier (figure \ref{fig: battery current sensor}). The output voltage $v_o = 2.5 - 47 i_\text{bat}$, where $i_{bat}$ is the current through R2. The gain (47) is given by the ratio of resistors R20 and R17 in figure \ref{fig: battery current sensor}. The \SI{2.5}{\volt} rail was used as a pseudo-ground to allow the output to swing in both the positive and negative direction without clipping. The output signal was input to a PIC ADC pin to allow its value to be determined by the software.\\



A circuit was also designed to monitor the voltage of the batteries, so as to detect an under-voltage condition. As the batteries discharged, their voltage also reduced. If the battery voltage fell below \SI{5.15}{\volt} (the voltage regulator rated voltage plus the dropout voltage), then the regulator would be unable to provide \SI{5}{\volt} to the remaining circuit. If the \SI{5}{\volt} rail was reduced, then the LED current and phototransistor output signal would be reduced, which would make the measurements inaccurate. Therefore, the PIC needed a way to detect an under-voltage condition, so that it could stop taking measurements and turn off any high-power systems, to prevent further battery discharge.\\

\begin{figure}[htb]
	\centering
	\includegraphics[width=0.8\linewidth]{battery voltage sensor.PNG}
	\caption{Battery under-voltage sensor.}
	\label{fig: battery voltage sensor}
\end{figure}

Figure \ref{fig: battery voltage sensor} shows the circuit used to detect the under-voltage condition. U6B is an op-amp which acts as a comparator with hysteresis, which is required to prevent oscillations. When the batteries provide current, their output voltage is reduced due to their internal impedance. This means that when the comparator indicates an under-voltage condition, the PIC will reduce the current load, so the battery voltage will rise. This may be above the comparator threshold, so the PIC will turn the current back on, leading to an oscillatory loop. With the hysteresis, the batteries must be charged above the upper threshold $v_{TH}$ before the comparator will change state. This threshold can be designed to give a stable voltage above \SI{5}{\volt} when the batteries are loaded. The upper threshold voltage was designed to be \SI{7.2}{\volt} and the lower threshold $v_{TL}$ was set to \SI{4.96}{\volt}. The potential divider R21 and R22 halves the battery voltage, because otherwise it would be too large for a \SI{5}{\volt} comparator. The resistors R23, R24 and R26 were chosen to set the threshold voltages according to the design equations \cite{hysteresis}:%(Rewrite) Explain loop more
\begin{multicols}{2}
\begin{equation}
\frac{v_{TL}}{v_{TH} - v_{TL}} = \frac{R26}{R23}
\end{equation}

\begin{equation}
\frac{v_{TL}}{5 - v_{TH}} = \frac{R24}{R23}
\end{equation}
\end{multicols}

Diode D7 was included because the PIC pin the circuit was connected to, RA3, was also the $\overline{\text{MCLR}}$ pin used by the PICkit3 programmer. This pin was raised to a high voltage during PIC programming. Diode D7 clamps the op-amp output to \SI{5}{\volt} to prevent damage during programming. The \SI{33}{\kilo\ohm} resistor allows the programmer to adjust the pin voltage independent of the op-amp, so the op-amp does not tie it high or low. The $\overline{\text{MCLR}}$ CONFIG bit had to be cleared in the PIC program to allow this pin to be used as a digital input. \\

Once the PIC detects an under-voltage condition, it will turn off all the outputs which consume power. The wireless transmitter module was designed with a PMOS switch on its Vcc rail, so that it could be fully switched off by the PIC. The PIC then transitions to its low-frequency oscillator mode, which uses a \SI{31}{\kilo\hertz} clock rather than the standard \SI{8}{\mega\hertz} clock. This reduces the quiescent current from \SI{2}{\milli\ampere} to \SI{30}{\micro\ampere} \cite{pic16f688}. Periodically, the PIC will check if the battery voltage has been restored, and if it has, then it will turn the device back on.
 



\subsection{Firmware}
The wireless charger requires a PWM signal with frequency $f=\SI{100}{\kilo\hertz}$ and duty cycle $D=0.5$. The PIC18F2550 has a built-in Capture/Compare/PWM (CCP) module \cite{pic18f2550}. This allows the PWM signal to be generated in hardware, rather than having to worry about precisely timing the software. A software implementation would have been difficult, as the PIC must do many other tasks as well as the PWM signal generation (such as listening for any incoming messages on the receiver). Thish would result in a variable delay time before the PWM could next be toggled. The CCP pin could be set up as PWM at the beginning of the program and would continue to generate the signal regardless of what the rest of the program was doing.\\

PICBASIC contains a built-in command to access the CCP pins, \verb|hpwm|. However, because the free version of MicroCode Studio does not support the long data type, the highest frequency \verb|hpwm| could deliver is \SI{32.767}{\kilo\hertz} \cite{picbasic_pro}. The wireless charger was designed to run at \SI{100}{\kilo\hertz}, so the PWM signal needed to be faster than \verb|hpwm| would allow. Therefore, a series of register writes were programmed to set up the CCP pin. The hardware was designed to use CCP module 2 on pin 24, which was multiplexed to \verb|PORTB.3|. CCP2 could be multiplexed to either \verb|PORTC.1| or \verb|PORTB.3|, so the appropriate CONFIG bit was set with the command \verb|CONFIG CCP2MX = OFF|.\\

The PIC18F2550 datasheet \cite{pic18f2550} detailed the required register writes to set up CCP2 as a PWM pin. First, the PWM period was written to the \verb|PR2| register (Timer2 period register). The PWM period is given by the equation:
\begin{equation}
\text{PWM Period} = [\text{PR2}+1] \times 4 \times T_\text{osc} \times (\text{TMR2 Prescale})
\end{equation}
where $T_\text{osc}$ is the oscillator period, so for an \SI{8}{\mega\hertz} clock $T_\text{osc}=\SI{125}{\nano\second}$. The factor of 4 is present because each PIC operation takes four clock cycles to be executed, so the effective clock speed is $f_\text{osc}/4$. For a TMR2 prescaler setting of x1, the required \verb|PR2| value was \verb|19| for a \SI{100}{\kilo\hertz} PWM signal. The duty cycle was then defined by the equation:
\begin{equation}
\text{PWM Duty Cycle} = (\text{CCPR2L:CCP2CON\textless5:4\textgreater}) \times T_\text{osc} \times (\text{TMR2 Prescale Value}) \label{eq: duty cycle}
\end{equation}
Where \verb|CCPR2L| is the CCP2 register low byte and \verb|CCP2CON<5:4>| are bits 5 and 4 of the CCP2 control register. Equation \ref{eq: duty cycle} implies $(\text{CCPR2L:CCP2CON\textless5:4\textgreater}) = \num{4e6}$, so \verb|0x0A| was written to \verb|CCPR2L| and \verb|0b00| was written to \verb|CCP2CON<5:4>|. After this was done, \verb|TRISB.3| was cleared to set the pin to a digital output. The TMR2 prescaler was set to x1 and Timer2 was enabled by writing \verb|0x04| to \verb|T2CON| (Timer2 control register). Finally, \verb|CCP2CON<3:2>| was set to \verb|0b11| in order to set CCP2 to PWM mode. This generated a stable \SI{100}{\kilo\hertz} square wave.

\begin{lstlisting}
#config
    CONFIG CCP2MX = OFF
#endconfig

'' Set up PWM to run in hardware at 100kHz, D = 0.5
PR2 = 19
CCPR2L = %00001010
CCP2CON.5 = 0
CCP2CON.4 = 0
TRISB.3 = 0
T2CON = %00000100
CCP2CON = %00001111
\end{lstlisting}




\subsection{Testing}
\begin{figure}[htb]
	\centering
	\includegraphics[width=\linewidth]{v2 rectangular coupling.png}
	\caption{Coupling coefficient for rectangular and circular coils. The legend gives $N_2/N_1$.}
	\label{fig: rectangular coupling}
\end{figure}

~\\
The charger was tested at \SI{100}{\kilo\hertz} using a 100-turn rectangular coil for the primary and a 150-turn rectangular coil for the secondary. The coils measured \SI{70 x 35}{\milli\metre}. Rectangular coils were required to maximise the coil area for the probe casing geometry. Figure \ref{fig: rectangular coupling} demonstrates that the coupling between the rectangular coils was identical to the circular coils used in the breadboard tests, so the results for the circular coils will have the same order of magnitude if repeated with rectangular coils.\\


\begin{figure}[htb]
	\centering
	\includegraphics[width=\linewidth]{secondary current.PNG}
	\caption{Battery charging current waveform at \SI{100}{\kilo\hertz} and a separation of \SI{10}{\milli\metre}.}
	\label{fig: secondary current}
\end{figure}



\begin{figure}[h!]
	\centering
	\includegraphics[width=\linewidth]{v2 charging current.png}
	\caption{Charging current delivered to \SI{7.2}{\volt} battery load at different coil separations.}
	\label{fig: current distance}
\end{figure}

The charging system was first tested to measure the current delivered to the \SI{7.2}{\volt} battery load at different coil separations. A \SI{3.2}{\pico\farad} capacitor was used to ensure the primary coil (with \SI{840}{\micro\henry} inductance) operated near resonance at \SI{100}{\kilo\hertz}. Figure \ref{fig: secondary current} shows that the current waveform observed in the batteries was a rectified sinusoid, as expected. Figure \ref{fig: current distance} demonstrates that the current-distance characteristics show a similar trend to the coupling-distance characteristics. The recommended charging current for the batteries is \SI{8}{\milli\ampere} \cite{rs_pro_batteries}, which is exceeded at distances less than \SI{28}{\milli\metre}. The minimum coil separation is \SI{10}{\milli\metre}, which includes the plastic casing surrounding the coils.\\

\begin{figure}[htb]
	\centering
	\includegraphics[width=\linewidth]{v2 resonant frequency.png}
	\caption{Charging current delivered to the \SI{7.2}{\volt} battery load where the resonant frequency is varied. The coils had a \SI{10}{\milli\metre} separation.}
	\label{fig: current resonance}
\end{figure}

The effect of changing the resonant frequency of the system was then measured. The \SI{3.2}{\pico\farad} capacitor was replaced with a series of other capacitors, and the PIC was reprogrammed to drive the coil at the LC resonant frequency. Figure \ref{fig: current resonance} shows that the maximum charging current is achieved at \SI{55}{\kilo\hertz} using a \SI{10}{\nano\farad} capacitor, so the system will operate at this frequency.\\ 

%The charging current decreases at low and high frequencies. %******WHY THE DECREASE AT LOW/HIGH FREQUENCIES************
%Therefore, the system will be designed to operate at \SI{55}{\kilo\hertz}, as this will provide the maximum current.\\

\begin{figure}[htb]
	\centering
	\includegraphics[width=\linewidth]{v2 frequency.png}
	\caption{Charging current delivered to the \SI{7.2}{\volt} battery load as a function of drive frequency for a fixed \SI{55}{\kilo\hertz} LC resonant frequency. The coils had a \SI{10}{\milli\metre} separation.}
	\label{fig: current frequency}
\end{figure}

The current delivered to the batteries at the \SI{55}{\kilo\hertz} resonance was \SI{36.8}{\milli\ampere}, which would fully charge the 80 mAh batteries in 2 hours 10 minutes. However, this is 4.6x the recommended charging current, so it could damage the batteries if they are charged at this current for a long time. By moving away from the resonant frequency, the voltage across the primary coil will decrease, and hence the current delivered to the batteries will also decrease. Therefore, by changing the drive frequency the charging current can be controlled, which is shown in figure \ref{fig: current frequency}. This means that the remote unit can be kept on a constant ``trickle charge'' when it is not in use, and then when a surgery is being prepared, the charger can change to a ``fast charge'' regime to ensure the device is fully charged for when it needs to be used. The recommended trickle charge for the batteries is \SIrange{2.4}{4}{\milli\ampere} \cite{rs_pro_batteries}.\\

\begin{table}[htb]
	\begin{center}
	\caption{Wireless charger power measurements.}
	\label{tab: efficiency}
	\begin{tabular}{|c|c|c|c|c|}
	\hline
	\textbf{Drive} & \textbf{Charging} & \textbf{Input} & \textbf{Output} & \\
	\textbf{Frequency} & \textbf{Current} & \textbf{Power} & \textbf{Power} & \textbf{Efficiency} \\
	(\si{\kilo\hertz}) & (\si{\milli\ampere}) & (\si{\watt}) & (\si{\watt}) & (\%)\\
	\hline
	55.7 & 39.4 & 2.76 & 0.306 & 11.1\\
	\hline
	45.5 & 8.69 & 1.05 & 0.067 & 6.42\\
	\hline	
	\end{tabular}
	\end{center}
\end{table}

The efficiency was then measured. The input voltage was \SI{12}{\volt}dc, and the RMS input current was measured across the \SI{22}{\ohm} series resistor in the RLC circuit. The output voltage was measured across the batteries when they were open circuit, and the RMS output current was measured across the \SI{1}{\ohm} current sense resistor. Table \ref{tab: efficiency} shows the measured efficiency when the circuit operates in resonance, and when it delivers the recommended \SI{8}{\milli\ampere} current. The efficiency is small (around 10\%), which is to be expected as the system uses air-cored coils which will have lots of leakage, and the coils have some resistive loss. Modern Qi mobile phone chargers have an efficiency of 70\%, although these use a more complex control system \cite{wireless_power_review}. This system has been designed to be simple and low-cost, so the efficiency penalty is justified. The base unit is mains powered, and its overall power consumption is small, so the low efficiency is not an issue. Nevertheless, the efficiency is better when the circuit is driven in resonance than when it is off resonance.\\ %*********WHY???********** 

When the batteries were loaded, their output voltage dropped from \SI{7.2}{\volt} to \SI{5.2}{\volt}. This means that there is only a small operating range where the LDO can provide a stable \SI{5}{\volt} rail. Upon reflection, it may have been better to use a buck-boost converter as this can maintain an output voltage which is higher than the input, so the lifetime of the device will increase.
% Maybe take this out??






\subsection{Power Budgets}\label{power budget}
\subsubsection{Remote Unit}



The PIC drew \SI{9.4}{\milli\ampere} when it was idle and running on an \SI{8}{\mega\hertz} clock. This gives the device a ``stand-by'' lifetime of \SI{8.5}{\hour}, as 80 mAh batteries are used. When the clock speed was reduced to \SI{31}{\kilo\hertz}, the current reduced to \SI{7.5}{\milli\ampere}. The \SI{1.9}{\milli\ampere} reduction helps to ensure that the batteries do not become fully discharged. Table \ref{tab: remote current} shows the currents drawn by the other components in the remote unit. In practice, the transmitter module drew negligible current, so there was no need to include the PMOS switch on its power rails. The current drawn when the IR LED was on was \SI{23.9}{\milli\ampere}. This was greater than the \SI{11.4}{\milli\ampere} design current from the circuit in figure \ref{fig: measurement schematic}. When the voltage across the \SI{220}{\ohm} resistor was measured, the correct current flowed through it, so the reason for the additional \SI{12.4}{\milli\ampere} is unknown at this time. Further tests using laboratory equipment may yield an explanation for this.\\

\begin{table}[htb]
	\begin{center}
	\caption{Current drawn by major components on the remote unit. These are expressed as a difference between the current measured when the PIC was idle and the current when the corresponding output pin was high.}
	\label{tab: remote current}
	\begin{tabular}{|c|c|c|c|c|}
	\hline
	& & & Tx module & Tx module\\
	\textbf{Component} & Red LED & IR LED & (low output) & (high output)\\
	\hline
	\textbf{Current (mA)} & 14.3 & 23.9 & 0 & 0.6 \\
	\hline
	\end{tabular}
	\end{center}
\end{table}

The total energy stored in the batteries is $E_\text{Bat} = \SI{7.2}{\volt}\times\SI{80}{\milli\ampere\hour}\times 80\% = \SI{1659}{\joule}$. The factor of 80\% is given by the batteries' datasheet \cite{rs_pro_batteries} and accounts for the fact that the batteries will only hold a stable \SI{7.2}{\volt} output for 80\% of their total capacity. The number of readings per full battery charge was then calculated. This assumed that the button LED was flashed 10 times in a button read, the measurement LED was flashed 50 times to probe the liver, the LEDs were on for \SI{1}{\milli\second} each flash, a \SI{1200}{\bit\per\second} baud rate was used, and the data was transmitted three times to add redundancy. It was also assumed that the button would only be polled once every \SI{100}{\milli\second}.\\

\begin{table}[htb]
	\begin{center}
	\caption{Energy used by different subsystems in the remote unit}
	\label{tab: remote energy}
	\begin{tabular}{*{5}{|c}|}
	\hline
	\textbf{System} & Button LED & Measurement LED & Wireless Tx & Idle time\\
	\hline
	\textbf{Energy (mJ)} & 1.07 & 5.34 & 23.1 & 4.70	 \\
	\hline
	\end{tabular}
	\end{center}
\end{table}

The calculated energies (table \ref{tab: remote energy}) were then summed to determine the number of readings which could be taken per full battery charge. When the probe was not in use, the button would activate every \SI{100}{\milli\second} and then the system would enter a delay period. This resulted in a stand-by time of 6.86 hours. If the probe was in constant use, so every button poll resulted in a measurement being taken, then 39,100 measurements could be taken, which corresponds to a lifetime of 5.95 hours. As the probe will be left on trickle charge when it is not in use, these lifetimes will be suitable for the probe to retain its charge during the transplant surgery.



\subsubsection{Base Unit}

\begin{table}[htb]
	\centering
	\caption{Current drawn by the major components on the base unit.}
	\label{tab: base current}
	\begin{adjustwidth}{-.5in}{-.5in}
	\begin{center}
	\begin{tabular}{|c|c|c|c|}
	\hline
	\multicolumn{2}{|c}{\textbf{5 V devices}} & \multicolumn{2}{|c|}{\textbf{3.3 V devices}}\\
	\hline
	\textbf{Component} & \textbf{Worst-case current (mA)} & \textbf{Component} & \textbf{Worst-case current (mA)} \\
	\hline
	PIC & 6 & LCD backlight & 100 \\
	\cline{3-4}
	LCD logic & 4 & \textbf{Total} & \textbf{100}\\
	\cline{3-4}
	LCD & 0.5 & \multicolumn{2}{c}{} \\
	\cline{3-4}
	Wireless Rx & 6 &  \multicolumn{2}{c|}{\textbf{12 V devices}} \\
	\cline{3-4}
	Wireless Tx & 12.5 & \textbf{Component} & \textbf{Worst-case current (mA)}  \\
	\cline{3-4}
	I\textsuperscript{2}C pullups & 4.5 & Wireless charger & 375 \\
	EEPROM & 3 & \SI{5}{\volt} converter & 37.6 \\
	RTC & 0.4 & \SI{3.3}{\volt} converter & 100 \\
	\cline{3-4}
	Push Buttons & 1 & \textbf{Total} & \textbf{512.6}  \\
	\hline
	\textbf{Total} & \textbf{37.9}  \\
	\cline{1-2}
	\end{tabular}
	\end{center}
	\end{adjustwidth}
\end{table}

The base unit required two voltage converters to generate a \SI{5}{\volt} and \SI{3.3}{\volt} rail. LDO regulators were selected due to their simplicity and their existing use in the remote unit. Although they will be inefficient, because the base is mains powered this will not be a problem. Each regulator needed to be able to provide the worst-case current to the components connected to those supply rails, as detailed in table \ref{tab: base current}. The large currents and voltage drops in the regulators led to a large power dissipation, which may lead to overheating in some packages.\\

\begin{figure}[htb]
	\centering
	\begin{subfigure}[b]{0.35\linewidth}
		\includegraphics[width=\linewidth]{parallel ldos.png}
		\caption{Parallel topology}
		\label{fig: parallel ldos}
	\end{subfigure}
	\begin{subfigure}[b]{0.5\linewidth}
		\includegraphics[width=\linewidth]{series ldos.png}
		\caption{Series topology}
		\label{fig: series ldos}
	\end{subfigure}
	\caption{Possible base voltage regulator topologies.}
	\label{fig: base ldos}
\end{figure}

The \SI{3.3}{\volt} rail could be created by stepping down either the \SI{12}{\volt} or the \SI{5}{\volt} rail (see figure \ref{fig: base ldos}). Both topologies led to the same total conversion loss of \SI{1.14}{\watt}, but the parallel topology was chosen because the \SI{5}{\volt} converter had a smaller output current, so it was less likely to reach the maximum available output current. To prevent overheating, the converters were set a maximum temperature rise of \SI{100}{\celsius} when operating at full output current. This meant that the junction-to-air thermal resistance had to be less than \SI{268}{\celsius\per\watt} for the \SI{5}{\volt} converter and \SI{86.2}{\celsius\per\watt} for the \SI{3.3}{\volt} converter. 

\begin{table}[htb]
	\centering
	\caption{Key properties of the LDO voltage regulators used in the base unit.}
	\label{tab: ldo properties}
	\begin{adjustwidth}{-.5in}{-.5in}
	\begin{center}
	\begin{tabular}{|c|c|c|c|c|c|}
%	\hline
%	\textbf{Property} & \textbf{MCP1702-5002} & \textbf{MCP1755-3302}\\
%	\hline
%	\textbf{Package} & TO-92 & SOT-223-5\\
%	\hline
%	\textbf{Output Voltage (\si{\volt})} & 5 & 3.3\\
%	\hline
%	\textbf{Thermal Resistance (\si{\celsius\per\watt})} & 131.9 & 62\\
%	\hline
%	\textbf{Operating Temperature (\si{\celsius})} & 60 & 79 \\
%	\hline
%	\textbf{Max. Output Current (\si{\milli\ampere})} & 250 & 300\\
%	\hline
	\hline
	& & \textbf{Output} & \textbf{Thermal} & \textbf{Operating} & \textbf{Max. Output} \\
	& & \textbf{Voltage} & \textbf{Resistance} & \textbf{Temperature} & \textbf{Current}\\
	\textbf{Device} & \textbf{Package} &  (\si{\volt}) &  (\si{\celsius\per\watt}) &  (\si{\celsius}) &  (\si{\milli\ampere})\\
	\hline
	\textbf{MCP1702-5002} & TO-92 & 5 & 131.9 & 60 & 250 \\
	\hline
	\textbf{MCP1755-3302} & SOT-223-5 & 3.3 & 62 & 79 & 300 \\
	\hline
	\end{tabular}
	\end{center}
	\end{adjustwidth}
\end{table}

The MCP1702-5002 \cite{mcp1702} in a TO-92 package was a suitable \SI{5}{\volt} regulator, and the MCP1755-3302 in a SOT-223-5 package was a suitable \SI{3.3}{\volt} regulator. Their properties are summarised in table \ref{tab: ldo properties}. They will operate at \SI{80}{\celsius} at most, but this is below the maximum operating temperature of \SI{150}{\celsius}, so they will not be damaged. They can both provide the required currents.\\

%The MCP1702-5002 \cite{mcp1702} in a TO-92 package had a thermal resistance of \SI{131.9}{\celsius\per\watt} and a maximum output current of \SI{250}{\milli\ampere} so was a suitable \SI{5}{\volt} converter. Additionally, it is the same converter used in the remote unit. This component would operate at \SI{60}{\celsius}, so would feel hot but since the maximum operating temperature was \SI{150}{\celsius} then the device would not be damaged. The MCP1755-3302 \cite{mcp1755} in a SOT-223-5 package had a thermal resistance of \SI{62}{\celsius\per\watt}, so would operate at \SI{79}{\celsius} under the worst case load. Again, this was below the maximum operating temperature of \SI{150}{\celsius}. The maximum output current was \SI{300}{\milli\ampere}, which again was above the expected current.\\
%Thermals can be reduced a bit

It should be noted that the currents given in this section are the worst-case, as the converters must be designed to provide up to the worst-case current before failing. The expected currents are much smaller, so the total power consumption will be less than that predicted above. This is estimated to be around \SI{2}{\watt}, \SI{0.66}{\watt} of which is wasted in the voltage regulators.

