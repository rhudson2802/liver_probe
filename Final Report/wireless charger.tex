\section{Wireless Charging and Power}\label{power}

\subsection{Hardware}

The remote unit was designed to run from a \SI{5}{\volt} supply. \SI{3.3}{\volt} was not suitable as the LEDs had a forward voltage of \SI{1.5}{\volt}, so a \SI{3.3}{\volt} supply would potentially be too small for the current source designed in figure \ref{fig: measurement schematic}. Therefore, a set of batteries had to be selected which would provide this voltage. The batteries had to be small to ensure the overall remote unit design was small enough to fit in the surgeon's hand, and needed to be rechargeable because of the hermetic seal. Two different chemistries were available from RS Components \cite{rs} in a small, rechargeable package: lithium ion (Li-ion) and Nickel Metal Hydride (NiMH). The NiMH chemistry was more suitable due to the increased safety. Li-ion batteries are highly sensitive to over/under-voltage and high temperatures, and can blow up if these limits are exceeded \cite{batteries}. This requires complex protection circuitry and may mean that the battery will not survive being placed in an autoclave. NiMH are much more resilient to over and under charging, so are much safer than Li-ion. They also have a higher energy density \cite{batteries}. Nevertheless, they are lower voltage so more cells will be required to provide the desired \SI{5}{\volt}, have a long charging time, and they have a high self-discharge rate \cite{batteries}. This is not such an issue for this application, as the remote unit can remain charging until it is required for an operation, and then it will only be used for a short time before being placed on charge again. A \SI{2.4}{\volt} \SI{80}{\milli\ampere\hour} RS-Pro NiMH button cell \cite{rs_pro_batteries} was selected as suitable. Three of these were used to give a nominal \SI{7.2}{\volt} supply, which gave a margin of 44\% for when the cells started to discharge.\\

A power converter then needed to be selected to drop the \SI{7.2}{\volt} battery voltage to the required \SI{5}{\volt} rail. A Low-Dropout (LDO) voltage regulator was deemed suitable for this application, as it would provide a stable voltage rail. The advantage over a buck converter is the smaller device size and design simplicity, but this comes at the cost of worse efficiency. Furthermore, the output voltage will not have the high frequency ripple associated with switch-mode converters, which is desirable to create a stable analogue rail to ensure that there is no measurement errors. The MCP1702T-5002E/CB \cite{mcp1702} in a SOT-23A package was suitable. This was a \SI{5}{\volt} regulator with a rated output current of \SI{250}{\milli\ampere}. This was well above the \SI{50}{\milli\ampere} maximum current required by the remote unit (see section \ref{power budget}). The quiescent current was \SI{2}{\micro\ampere}, which is negligible compared with the remainder of the circuit, so the regulator will not affect the battery lifetime. The regulator will dissipate a maximum of $(\SI{7.2}{\volt}-\SI{5}{\volt})\times\SI{50}{\milli\ampere}=\SI{110}{\milli\watt}$. The SOT-23A package has a junction to air thermal resistance of \SI{336}{\celsius\per\watt}, so the maximum temperature increase is \SI{37}{\celsius}. In fact, the device will rarely operate at \SI{50}{\milli\ampere}, so the regulator will remain at ambient temperature.\\

\begin{figure}[htbp]
	\centering
	\includegraphics[width=\linewidth]{h bridge charger.PNG}
	\caption{Circuit schematic for H-Bridge inductive wireless charger. The left hand side circuit is included in the base unit, and the right hand side circuit is included in the remote unit.}
	\label{fig: charger schematic}
\end{figure}
	

Inductive charging was selected as an appropriate method of recharging the batteries. This involved placing two air-cored coils in close proximity, applying an AC voltage to the primary and rectifying the voltage across the secondary. This is a similar design to that used in other hermetically sealed low power products, such as an electric toothbrush's charger \cite{wireless_power_review}. Figure \ref{fig: charger schematic} shows the circuit schematic, which uses two PMOS and NMOS pairs in a H-bridge arrangement to generate the AC voltage. The MOSFETs are arranged in a CMOS inverter structure, so when the input gate voltage is high, their output is low, and when the gate is low their output is high. The two half bridges are driven with inverted signals, so the voltage across the load alternates between \SI{\pm 5}{\volt}. The series capacitor is used to create a resonant circuit with the inductor, which increases the voltage across the primary coil and smooths the square wave input voltage waveform to a sinusoid across the inductor. The capacitor is designed to give the circuit a resonant frequency equal to the drive frequency, to get the maximum gain possible. The series resistor is included to limit the current through the circuit. An ideal series LC circuit has zero impedance at resonance, so it will look like a short circuit to the external circuit. The PMOS transistors had a current rating of \SI{230}{\milli\ampere}, so using a series resistance of \SI{22}{\ohm} will limit the current to \SI{227}{\milli\ampere}, with the channel resistance of the MOSFETs and parasitic LC resistances acting to reduce it further.\\

The primary coil will generate an alternating magnetic field due to the sinusoidal voltage across it. This couples with the secondary coil to induce an alternating voltage. The coupling of air-cored transformers is very poor, so a large voltage will be required across the primary coil to ensure the secondary coil receives enough volts. The resonant circuit aids this. The secondary coil's alternating voltage is then rectified to a DC voltage by a diode bridge. The NSR05F20NXT5G Schottky barrier diode \cite{original_diode} was used in the diode bridge. These were chosen because of their very low forward voltage, \SI{0.2}{\volt}, which would make sure that the required secondary voltage was kept as small as possible. A larger diode drop would mean a larger secondary voltage was required, which could cause problems under the low coupling conditions of the air-cored transformer. Their reverse leakage was \SI{2}{\micro\ampere}, which was also good. They were rated to \SI{20}{\volt} and \SI{500}{\milli\ampere}, which were well below the expected operating conditions of \SI{10}{\volt} and \SI{10}{\milli\ampere}. The battery voltage was \SI{7.2}{\volt}, so the total required voltage across the secondary including the two diode drops was \SI{7.6}{\volt}.\\

\begin{figure}[htbp]
	\centering
	\includegraphics[width=0.8\linewidth]{coil inductance.png}
	\caption{Measured coil inductance for different numbers of coil turns}
	\label{fig: coil inductance}
\end{figure}

The inductance of a solenoid is given by 
\begin{equation}\label{eq: solenoid}
L = \frac{\mu_0 N^2 A}{l}
\end{equation}
where $\mu_0$ is the permeability of free space, $N$ is the number of turns, $A$ is the cross-sectional area of the solenoid and $l$ is the length of the solenoid. The circular coils constructed for the wireless charger had an inner diameter of \SI{5}{\centi\metre}, and an average length of \SI{0.5}{\centi\metre} (this varied depending on the number of turns). Substituting these geometry parameters in equation \ref{eq: solenoid} implies that $L=\num{4.93e-7}N^2$. The coil inductance was then experimentally determined by measuring the resonant frequency of an LC circuit with known capacitance. The signal was a sinusoid generated from a PicoScope 2204A \cite{picoscope} with a series resistor at the output. The frequency was varied until the maximum output voltage across a parallel LC tank was measured. After this, the capacitance required for the circuit to be resonant at \SI{100}{\kilo\hertz} was calculated, by $C = 1/L(2\pi f_\text{res})^2$. Figure \ref{fig: coil inductance} shows the variation of coil inductance with the number of turns. The inductance follows a quadratic dependence on the number of turns, as is to be expected from equation \ref{eq: solenoid}. However, the coefficient is 100x smaller than equation \ref{eq: solenoid} predicts. This could be because equation \ref{eq: solenoid} assumes the flux within the solenoid is uniform, which may not be the case for the circular planar coil as the short length may lead to lots of fringing effects, which could influence the flux distribution. Furthermore, the construction of the coils meant that there was not a uniform distribution of the coil turns and there was significant overlap of the turns, which could also influence the measured inductance.\\

\begin{figure}[htbp]
	\centering
	\includegraphics[width=0.4\linewidth]{coil experiment.png}
	\caption{Setup for coil experiments}
	\label{fig: coil experiment setup}
\end{figure}
\begin{figure}[htbp]
	\centering
	\includegraphics[width=0.8\linewidth]{circular coupling.PNG}
	\caption{The experimentally derived coupling coefficient of circular coils as a function of coil separation. The legend gives the turns ratio $N_2/N_1$ for the different experiments.}
	\label{fig: circular coupling}
\end{figure}

The performance of the proposed charging circuit was investigated. First, the coupling coil was determined as a function of the separation between the coils. The experiment was performed using two planar circular coils. The coils were centred on the same out-of-plane axis. Figure \ref{fig: coil experiment setup} illustrates the experiment setup. The primary coil was driven by the H-bridge circuit in figure \ref{fig: charger schematic}, and the secondary coil had its open circuit voltage measured. If the transformer were ideal, the secondary coil's voltage should be $V_2 = V_1 \times N_2 / N_1$ where $V_1$ is the voltage across the primary coil, and $N_2 / N_1$ is the secondary to primary turns ratio. To account for the poor coupling in an air-cored transformer, a coupling coefficient $k$ is introduced, so $V_2 = k \times V_1 \times N_2 / N_1$. The reduction in coupling is because the air core has a low permeability, so the flux from the primary is not strongly linked to the secondary, leading to a large leakage flux. The experiment was repeated for different turns ratios, all giving similar values of the coupling coefficient.. The experimentally determined coupling coefficients are plotted in figure \ref{fig: circular coupling}, which shows a coupling coefficient of 0.28 at a separation of \SI{10}{\milli\metre}.\\


\begin{figure}[htbp]
	\centering
	\includegraphics[width=0.6\linewidth]{charger simulation.PNG}
	\caption{LTspice simulation of charger circuit}
	\label{fig: charger simulation}
\end{figure}

The circuit was simulated in LTspice \cite{ltspice}, with the circuit schematic shown in figure \ref{fig: charger simulation}. A voltage source with series resistance was used to model the H-bridge output. The circuit was tested on breadboard, so the surface mount NSR05F20NXT5G diodes could not be used. Instead, a through-hole diode was selected for testing purposes (Vishay UF4001-E3/54 \cite{tht_diode}), and this diode was modelled in the LTspice simulation, so the results could be compared with the experimental results. The coupling between the coils was set to 0.28, to model \SI{10}{\milli\metre} coil separation. The inductors and batteries had an equivalent series resistance modelled as well. The simulation suggested that the primary coil should have an RMS voltage of \SI{44.4}{\volt}, and the secondary coil should have an RMS voltage of \SI{8.24}{\volt}. This led to an average battery charging current of \SI{13.1}{\milli\ampere}, which would be suitable to recharge the remote unit. 

\begin{table}[htbp]
	\begin{center}
	\begin{tabular}{|l|*{4}{c|}}
		\hline
		\backslashbox{\textbf{Primary Turns}}{\textbf{Secondary Turns}} & \textbf{50} & \textbf{100} & \textbf{160} & \textbf{200} \\
		\hline
		\textbf{50} & - & 3.97 & 5.32 & 3.32 \\
		\hline
		\textbf{100} & 4.46 & - & 5.22 & 4.75 \\
		\hline
		\textbf{160} & 3.95 & 4.15 & - & 3\\
		\hline
	\end{tabular}
	\caption{Current measurements (in milliamps) across a 7.2V battery load for varying combinations of primary and secondary coil. The coils were touching.}
	\label{tab: coil combinations}
	\end{center}
\end{table}

The charger was tested to see the effect of changing the number of turns in the primary and secondary coils (table \ref{tab: coil measurements}). The best combination of primary and secondary coils are the 50/160 and 100/160 combinations. The breadboard experiments indicated a maximum charging current of \SI{5}{\milli\ampere} when the coils were touching, which is much less than the simulated value at \SI{10}{\milli\metre} separation. At \SI{10}{\milli\metre} separation, the charger could only deliver around \SI{0.5}{\milli\ampere}. This could be because of the presence of parasitic elements within the circuit damping the resonance and reducing the magnitude of the currents. \\ 



The initial tests indicated that the charger would not deliver sufficient current to charge the batteries quickly, as the recommend current to charge the batteries in 16 hours is \SI{8}{\milli\ampere}. Therefore, the supply voltage was stepped up to \SI{12}{\volt}, as this would mean that there would be more volts at the secondary side, so a greater current would flow. The circuit in figure \ref{fig: charger schematic} needed to be adapted to the \SI{12}{\volt} supply. A gate driver needed to be designed for the PMOS to provide it with a \SI{12}{\volt} gate signal rather than the \SI{5}{\volt} signal the PIC provides. Because the PMOS gate voltage is referred to the \SI{12}{\volt} rail, if a \SI{5}{\volt} signal were applied to the gate then it would remain on, as the gate-source voltage (\SI{7}{\volt}) will be greater than the threshold voltage. This will result in a large shoot-through current when the corresponding NMOS is on, as it will look like a short to ground to the supply. This will damage the MOSFETs and the supply, as well as not allowing the charger to operate properly. \\

\begin{figure}[htbp]
	\centering
	\includegraphics[width=0.8\linewidth]{mcp1407.PNG}
	\caption{Schematic of MCP1406/07 MOSFET driver internal circuitry \cite{mcp1407}}
	\label{fig: mcp1407}
\end{figure}

To avoid this problem, two MOSFET driver ICs (Microchip's MCP1406 and MCP1407 \cite{mcp1407}) were selected to replace the H-bridge. These ICs were designed to drive the gate of a power MOSFET, but are suitable for this application because they supply a large current (up to \SI{6}{\ampere}) and large voltage (up to \SI{18}{\volt}). Figure \ref{fig: mcp1407} demonstrates that the internal circuitry of the MCP1406/07 takes an input CMOS/TTL signal (at signal levels the PIC can provide), and uses this to drive a push-pull CMOS inverter. Therefore, the H-bridge MOSFETs can be replaced by these ICs, as they take care of the gate drive. The drivers come in two varieties: the inverting MCP1406 and the non-inverting MCP1407. Choosing one of each (for the different sides of the H-bridge) means only one input signal is required from the PIC, freeing up an I/O pin for other uses. The propagation times for both devices are the same (\SI{40}{\nano\second}), so there is no risk of dangerous shoot-through currents, assuming they are placed close enough together on the PCB that the delay time in the PCB traces is negligible.\\

\begin{figure}[htbp]
	\centering
	\includegraphics[width=\linewidth]{mosfet drivers charger.PNG}
	\caption{Circuit schematic showing the primary side of the charging circuit using the MCP1406/07 MOSFET drivers.}
	\label{fig: mosfet drivers charger}
\end{figure}

The schematic for the primary side is shown in figure \ref{fig: mosfet drivers charger}. The inclusion of the three capacitors C9, C22 and C23 is so that the resonant circuit can be tuned to \SI{100}{\kilo\hertz} more accurately. A \SI{22}{\ohm} resistor was used again to limit the current to \SI{500}{\milli\ampere}, as this was the maximum current the power supply could provide. The circuit provided \SI{2.5}{\milli\ampere} of charging current to the three \SI{2.4}{\volt} batteries when tested on breadboard with the coils separated by \SI{10}{\milli\metre}. This was reflective of the real use conditions, and the \SI{2.5}{\milli\ampere} charging current was suitable. The batteries' recommended charging current is \SI{8}{\milli\ampere}, so while the current is a little low this will not be a large problem as it is expected that the remote unit will be left on constant charge. The \SI{2.5}{\milli\ampere} current will fully charge the \SI{80}{\milli\ampere\hour} batteries in \SI{32}{\hour}.\\

Using the \SI{12}{\volt} supply voltage resulted in \SI{112}{\volt} across the primary coil, and \SI{51}{\volt} across the secondary (under open circuit conditions with \SI{10}{\milli\metre} separation). This was greater than the NSR05F20NXT5G voltage rating \SI{20}{\volt}, so new diodes were selected for the bridge rectifier to handle the higher voltage. The NXP PMEG10020ELRX Schottky barrier diode \cite{new_diode} was rated to \SI{100}{\volt} and \SI{2}{\ampere}, so was suitable for the application. It also had a low forward voltage of \SI{0.4}{\volt}, which was larger than the original diode, but because of the much larger secondary coil voltage this will not be a problem. It also has a very low reverse current of \SI{10}{\nano\ampere} at \SI{25}{\celsius}, which will lead to good off-state performance.\\




\begin{figure}[htbp]
	\centering
	\includegraphics[width=0.8\linewidth]{battery current sensor.PNG}
	\caption{Battery current sensor.}
	\label{fig: battery current sensor}
\end{figure}

A current sensor was included to measure the remote unit's charging and discharging currents. A \SI{1}{\ohm} resistor (R2 in figure \ref{fig: charger schematic}) was placed in series with the batteries to develop a voltage proportional to the current through the batteries. R2 was placed between BT2 and BT3 so it sat at \SI{2.4}{\volt}, which was important to ensure that the voltage input to the amplifier was not close to the amplifier supply rails, which would have resulted in clipping otherwise. The voltage across R2 was used as the input to a differential amplifier (figure \ref{fig: battery current sensor}). The output voltage $v_o = 2.5 - 47v_\text{sense} = 2.5 - 47 i_\text{bat}$, where $v_\text{sense}$ is the voltage across the current sense resistor R2, which in turn is equal to the battery current $i_\text{bat}$ because a \SI{1}{\ohm} resistor is used. The gain (47) is given by the ratio of resistors R20 and R17 (or equivalently R19 and R18) in figure \ref{fig: battery current sensor}. The \SI{2.5}{\volt} rail was used as a pseudo-ground for the non-inverting input to bias the output voltage at \SI{2.5}{\volt}, which would then be able to swing in both the positive and negative direction without clipping. If the real ground rail were used, the output voltage would be \SI{0}{\volt} for all discharging currents as the output cannot swing negative from a unipolar supply. The output signal was input to a PIC ADC pin to allow its value to be determined by the firmware.\\



A circuit was also designed to monitor the voltage of the batteries, importantly to detect an under-voltage condition. As the batteries discharged, their voltage also reduced. If the battery voltage fell below \SI{5.15}{\volt} (the voltage regulator's rated voltage plus the dropout voltage), then the regulator would be unable to provide \SI{5}{\volt} to the remaining circuit. If the \SI{5}{\volt} rail was reduced, then the LED current and phototransistor output signal would be reduced, which means that the measurements would be inaccurate. Therefore, the PIC needed a way to detect an under-voltage condition, so that it could stop taking measurements (which would be wrong data), and cut-off any high power systems to prevent further battery discharge.\\

\begin{figure}[htbp]
	\centering
	\includegraphics[width=\linewidth]{battery voltage sensor.PNG}
	\caption{Battery under-voltage sensor}
	\label{fig: battery voltage sensor}
\end{figure}

Figure \ref{fig: battery voltage sensor} shows the circuit used to detect the under-voltage condition. U5 is the MCP1702 LDO voltage regulator described at the start of section \ref{power}. U6B is an op-amp which acts as a comparator with hysteresis. The hysteresis is required to prevent oscillations. When the batteries provide current, their output voltage is reduced due to their internal impedance. If the circuit immediately cut off the current when an under-voltage condition were detected, then the battery voltage would immediately rise due to the reduced current, so the comparator would then indicate that the voltage was fine, allowing the current to flow which would cause an oscillatory loop. With the hysteresis, the batteries must be charged to above the upper threshold voltage $v_{TH}$ before the comparator will indicate that the battery voltage has risen, so this threshold can be designed to give a stable voltage above \SI{5}{\volt} when the batteries are loaded. The upper threshold voltage was designed to be \SI{7.2}{\volt} (when the batteries were open circuit) and the lower threshold $v_{TL}$ was set to \SI{4.96}{\volt} (when the batteries were closed circuit). The battery voltage is halved by the potential divider R21 and R22, because it would otherwise be too large for a \SI{5}{\volt} comparator. The resistors R23, R24 and R26 were chosen to set the threshold voltages according to the design equations \cite{hysteresis}:

\begin{multicols}{2}
\begin{equation}
\frac{v_{TL}}{v_{TH} - v_{TL}} = \frac{R26}{R23}
\end{equation}

\begin{equation}
\frac{v_{TL}}{5 - v_{TH}} = \frac{R24}{R23}
\end{equation}
\end{multicols}

R25 was set to \SI{0}{\ohm} so an extra footprint would be placed on the PCB design to allow for fine tuning of the hysteresis, if the original design were found to not be suitable during testing. Diode D7 was included because the PIC pin the circuit was connected to, RA3, was also the $\overline{\text{MCLR}}$ pin used by the PICkit3 programmer. This pin raised to a high voltage during PIC programming. Diode D7 clamps the op-amp output to \SI{5}{\volt} to prevent damage during programming. The \SI{33}{\kilo\ohm} resistor allows the programmer to adjust the pin voltage independent of the op-amp, so the op-amp does not tie it high or low. The $\overline{\text{MCLR}}$ config bit had to be cleared in the PIC program to allow this pin to be used as a digital input. \\

Once the PIC detects an under-voltage condition, it will turn off all of the outputs which consume power. It is important that the circuit does not continue to draw current, as this may drain the batteries too much so they can no longer be recharged. The wireless transmitter module was designed with a PMOS switch at its Vcc rail so that it could be fully switched off by the PIC (as it consumes some power even when it is not transmitting, for instance to power the local oscillator). The PIC then transitions to its low frequency oscillator mode, which uses a \SI{31}{\kilo\hertz} clock rather than the standard \SI{8}{\kilo\hertz} clock. This reduces the quiescent current from \SI{2}{\milli\ampere} to \SI{30}{\micro\ampere}. Periodically, the PIC will perform a read operation to see if the battery voltage has been restored, and if it has then it will turn the device back on.\\





\subsection{Firmware}
The wireless charger requires a PWM signal with frequency $f=\SI{100}{\kilo\hertz}$ and duty cycle $D=0.5$. The PIC18F2550 has a built-in Capture/Compare/PWM (CCP) module \cite{pic18f2550}. This allows the PWM signal to be generated in hardware, rather than having to worry about precisely timing the software. A software implementation would have been difficult, as the PIC must do many other tasks as well as the PWM signal generation (such as listening for any incoming messages on the receiver), which would result in a variable delay time before the PWM could next be toggled. This is undesirable as it would not produce the desired constant frequency and duty ratio signal. The CCP pin could be set up as PWM at the beginning of the program and would continue to generate the signal regardless of what the rest of the program was doing.\\

PICBASIC contains a built-in command to access the CCP pins, \verb|hpwm| (hardware PWM). This allows PWM to be set up simply by specifying the output pin, frequency and duty cycle \cite{picbasic_pro}. However, because the free version of MicroCode Studio does not support the long data type, the highest frequency it can deliver is \SI{32.767}{\kilo\hertz}. The wireless charger was designed to run at \SI{100}{\kilo\hertz}, so the PWM signal needed to be faster than HPWM would allow. Therefore, a series of register writes were programmed to set up the CCP pin. The hardware was designed to use CCP module 2 on pin 24, which was multiplexed to PORTB.3. CCP2 could be multiplexed to either PORTC.1 (the default) or PORTB.3. Therefore, the appropriate CONFIG bit was set. In PICBASIC, this was \verb|CONFIG CCP2MX = OFF|.\\

The PIC18F2550 data sheet \cite{pic18f2550} detailed the required register writes to set up CCP2 as a PWM pin. First, the PWM period was written to the PR2 register (Timer2 period register). The PWM period is given by the equation:
\begin{equation}
\text{PWM Period} = [\text{PR2}+1] \times 4 \times T_\text{osc} \times (\text{TMR2 Prescale})
\end{equation}

where $T_\text{osc}$ is the oscillator period, so for a \SI{8}{\mega\hertz} clock speed $T_\text{osc}=\SI{125}{\nano\second}$. The factor of 4 is because each PIC operation takes four clock cycles to be executed, so the effective clock speed is $f_\text{osc}/4$. For a TMR2 prescaler setting of x1, the required PR2 value was 19 for a \SI{100}{\kilo\hertz} PWM signal. Every clock cycle, the Timer2 module increments the TMR2 register. TMR2 is then compared to the PR2 register, and if the two are equal then the TMR2 is reset to 0 on the next clock cycle \cite{pic18f2550}. This is how the \SI{100}{\kilo\hertz} interval is generated. The duty cycle was then defined by the equation:
\begin{equation}
\text{PWM Duty Cycle} = (\text{CCPR2L:CCP2CON\textless5:4\textgreater}) \times T_\text{osc} \times (\text{TMR2 Prescale Value}) \label{eq: duty cycle}
\end{equation}

Where CCPR2L is the CCP2 register low byte and CCP2CON\textless5:4\textgreater are bits 5 and 4 of the CCP2 control register which define the lower two bits of the duty cycle period. Equation \ref{eq: duty cycle} implies $(\text{CCPR2L:CCP2CON\textless5:4\textgreater}) = \num{4e6}$, so 0x0A was written to CCPR2L and 0b00 was written to CCP2CON\textless5:4\textgreater. After this was done, TRISB.3 was cleared to set the pin to a digital output. The TMR2 prescaler was set to x1 and Timer2 was enabled by writing 0x04 to T2CON (Timer2 control register). Finally, CCP2CON\textless3:2\textgreater was set to 0b11, to set CCP2 to PWM mode. This generated a stable \SI{100}{\kilo\hertz} square wave. The PICBASIC code is given below.\\
\begin{lstlisting}
#config
    CONFIG CCP2MX = OFF
#endconfig

'' Set up PWM to run in hardware at 100kHz, D = 0.5
PR2 = 19
CCPR2L = %00001010
CCP2CON.5 = 0
CCP2CON.4 = 0
TRISB.3 = 0
T2CON = %00000100
CCP2CON = %00001111
\end{lstlisting}




\subsection{Testing}
\begin{figure}[htbp]
	\centering
	\includegraphics[width=0.8\linewidth]{rectangular coupling.png}
	\caption{Coupling coefficient as a function of coil separation for both rectangular and circular coils.}
	\label{fig: rectangular coupling}
\end{figure}


The charger was tested at \SI{100}{\kilo\hertz} using a 100 turn rectangular coil for the primary and a 150 turn rectangular coil for the secondary. The coils measured \SI{70 x 35}{\milli\metre}. Rectangular coils were required to maximise the coil area for the probe casing geometry. Figure \ref{fig: rectangular coupling} demonstrates that the coupling between the rectangular coils was identical to the circular coils used in the breadboard tests, so the results for the circular coils will have the same order of magnitude when repeated with rectangular coils.\\


\begin{figure}[htbp]
	\centering
	\includegraphics[width=\linewidth]{secondary current.PNG}
	\caption{Charging current supplied to the batteries at \SI{100}{\kilo\hertz} and a separation of \SI{10}{\milli\metre}.}
	\label{fig: secondary current}
\end{figure}



\begin{figure}[htbp]
	\centering
	\includegraphics[width=0.8\linewidth]{charging current.png}
	\caption{Charging current delivered to \SI{7.2}{\volt} battery load at different coil separations.}
	\label{fig: current distance}
\end{figure}

The charging system was first tested to measure the current delivered to the \SI{7.2}{\volt} battery load at different coil separations. A \SI{3.2}{\pico\farad} capacitor was used to ensure the primary coil (with \SI{840}{\micro\henry} inductance) operated near resonance at \SI{100}{\kilo\hertz}. Figure \ref{fig: secondary current} shows that the current waveforms observed in the batteries is the expected rectified sinusoid. Figure \label{fig: current distance} shows the results of this experiment, demonstrating the current-distance characteristics have a similar trend to the coupling-distance characteristics, as might be expected. The recommended charging current for the batteries is \SI{8}{\milli\ampere} \cite{rs_pro_batteries}, which is exceeded at distances less than \SI{28}{\milli\metre}. The expected minimum coil separation is \SI{10}{\milli\metre}, which takes into account the plastic casing surrounding the coils.\\

\begin{figure}[htbp]
	\centering
	\includegraphics[width=0.8\linewidth]{resonant frequency.png}
	\caption{Charging current delivered to \SI{7.2}{\volt} battery load where the resonant frequency is varied. The coils had a \SI{10}{\milli\metre} separation.}
	\label{fig: current resonance}
\end{figure}

The effect of changing the resonant frequency of the system was then measured. The \SI{3.2}{\pico\farad} capacitor was replaced with a series of other capacitors, and the PIC was reprogrammed to drive the coil at the LC resonant frequency. Figure \ref{fig: current resonance} shows that the maximum charging current is achieved at \SI{55}{\kilo\hertz} (which used a \SI{10}{\nano\farad} capacitor). The charging current decreases at low and high frequencies. %******WHY THE DECREASE AT LOW/HIGH FREQUENCIES************
Therefore, the system will be designed to operate at \SI{55}{\kilo\hertz}, as this will provide the maximum current.\\

\begin{figure}[htbp]
	\centering
	\includegraphics[width=0.8\linewidth]{frequency.png}
	\caption{Charging current delivered to \SI{7.2}{\volt} battery load as a function of drive frequency, for a fixed \SI{55}{\kilo\hertz} LC resonant frequency. The coils had a \SI{10}{\milli\metre} separation.}
	\label{fig: current frequency}
\end{figure}

The current delivered to the batteries at the \SI{55}{\kilo\hertz} resonance was \SI{36.8}{\milli\ampere}, which will fully charge the \SI{80}{\milli\ampere\hour} batteries in 2 hours 10 minutes. However, this is 4.6x the recommended charging current so could damage the batteries if they are charged at this current for a long time. By moving away from the resonant frequency, the voltage across the primary coil will decrease, and hence the current delivered to the batteries will also decrease. Figure \ref{fig: current frequency} shows the relationship between drive frequency and charging current. Therefore, by changing the drive frequency the charging current can be controlled. This means that the remote unit could be kept on a constant ``trickle charge'' when it is not in use, and then when a surgery is being prepared then the charger could change to a ``fast charge'' regime to ensure the device is fully charged for when it needs to be used. The recommended trickle charge for the batteries is \SIrange{2.4}{4}{\milli\ampere} \cite{rs_pro_batteries}. Furthermore, because the remote unit has a battery current monitor, it could send the actual charging current back to the base unit to create a feedback loop, and the base unit could have a control law implemented to keep the current constant by varying the drive frequency.\\

\begin{table}[htbp]
	\begin{center}
	\begin{tabular}{|c|c|c|c|c|}
	\hline
	\textbf{Drive} & \textbf{Charging} & \textbf{Input} & \textbf{Output} & \\
	\textbf{Frequency} & \textbf{Current} & \textbf{Power} & \textbf{Power} & \textbf{Efficiency} \\
	(\si{\kilo\hertz}) & (\si{\milli\ampere}) & (\si{\watt}) & (\si{\watt}) & (\%)\\
	\hline
	55.7 & 39.4 & 2.76 & 0.306 & 11.1\\
	\hline
	45.5 & 8.69 & 1.05 & 0.067 & 6.42\\
	\hline	
	\end{tabular}
	\caption{Wireless charger power measurements.}
	\label{tab: efficiency}
	\end{center}
\end{table}

The efficiency was then measured. The input voltage was \SI{12}{\volt}dc, and the RMS input current was measured across the \SI{22}{\ohm} series resistor in the RLC circuit. The output voltage was measured across the batteries when they were open circuit, and the RMS output current was measured across the \SI{1}{\ohm} current sense resistor. Table \ref{tab: efficiency} shows the measured efficiency when the circuit operates in resonance, and when it delivers the recommended \SI{8}{\milli\ampere} current. The efficiency is small (around 10\%), which is to be expected as the system uses air cored coils which will have lots of leakage, and the coils have some resistive loss. Modern Qi mobile phone chargers have an efficiency of 70\% \cite{wireless_power_review}, so the system is much less efficient than the state-of-the-art. However, the Qi standard uses a more complex control system involving communication between the receiver and transmitter \cite{wireless_power_review}, whereas this system has been designed for simplicity and low-cost so the efficiency penalty is justified. The base unit is mains powered and its overall power consumption is small, so the low efficiency is not an issue. Nevertheless, the efficiency is better when the circuit is driven in resonance than when it is off-resonance.\\ %*********WHY???********** 

When the batteries were loaded, their output voltage dropped from \SI{7.2}{\volt} to around \SI{5.2}{\volt}. This means that there will only be a small operating range where the LDO can provide a stable \SI{5}{\volt} rail. Upon reflection, it may have been better to use a buck-boost converter as this can maintain an output voltage which is higher than the input, so the lifetime of the device will increase.\\






\subsection{Power Budgets}\label{power budget}
\subsubsection{Remote Unit}

\begin{table}[htbp]
	\begin{center}
	\begin{tabular}{|c|c|c|c|c|}
	\hline
	Component & Red LED & IR LED & Tx module (low output) & Tx module (high output)\\
	\hline
	Current (mA) & 14.3 & 23.9 & 0 & 0.6 \\
	\hline
	\end{tabular}
	\caption{Current drawn by major components on remote unit. These are expressed as a difference between the current measured when the PIC is idle to the current when the corresponding output pin is high.}
	\label{tab: remote current}
	\end{center}
\end{table}

The PIC drew \SI{9.4}{\milli\ampere} when it was idle and running on a \SI{8}{\mega\hertz} clock. This gives the device's ``stand-by'' lifetime to be \SI{8.5}{\hour}, as \SI{80}{\milli\ampere\hour} batteries are used. When the clock speed was reduced to \SI{31}{\kilo\hertz}, the current reduced to \SI{7.5}{\milli\ampere}. The \SI{1.9}{\milli\ampere} reduction will help to ensure that the batteries do not become fully discharged. Table \ref{tab: remote current} shows the currents drawn by the other components in the remote unit. The transmitter module draws negligible current in practice, so there was in fact no need to include the PMOS power switch.\\

LED CURRENTS\\

INCLUDE ONCE 100 mA ISSUE HAS BEEN FIXED\\


\subsubsection{Base Unit}

\begin{table}[htbp]
	\begin{center}
	\begin{tabular}{|c|c|c|c|}
	\hline
	\multicolumn{2}{|c}{\textbf{\SI{5}{\volt} devices}} & \multicolumn{2}{|c|}{\textbf{\SI{3.3}{\volt} devices}}\\
	\hline
	\textbf{Component} & \textbf{Worst case current (\si{\milli\ampere})} & \textbf{Component} & \textbf{Worst case current (\si{\milli\ampere})} \\
	\hline
	PIC & 6 & LCD backlight & 100 \\
	\cline{3-4}
	LCD logic & 4 & \textbf{Total} & 100\\
	\cline{3-4}
	LCD & 0.5 & \multicolumn{2}{c}{} \\
	\cline{3-4}
	Wireless Rx & 6 &  \multicolumn{2}{c|}{\textbf{\SI{12}{\volt} devices}} \\
	\cline{3-4}
	Wireless Tx & 12.5 & \textbf{Component} & \textbf{Worst case current (\si{\milli\ampere})}  \\
	\cline{3-4}
	I\textsuperscript{2}C pullups & 4.5 & Wireless charger & 375 \\
	EEPROM & 3 & \SI{5}{\volt} converter & 37.6 \\
	RTC & 0.4 & \SI{3.3}{\volt} converter & 100 \\
	\cline{3-4}
	Push Buttons & 1 & \textbf{Total} & 512.6  \\
	\hline
	\textbf{Total} & 37.9  \\
	\cline{1-2}
	\end{tabular}
	\caption{Current drawn by major components on the base unit.}
	\label{tab: base current}
	\end{center}
\end{table}

The base unit required two voltage converters to generate a \SI{5}{\volt} and \SI{3.3}{\volt} rail. LDO regulators were selected due to their simplicity and their existing use in the remote unit. Although they will be inefficient, because the base is mains powered this will not be a problem. Table \label{fig: base current} shows the worst case current drawn by each component on the base unit. The main concern with the base power supply was that the \SI{5}{\volt} and \SI{3.3}{\volt} regulators needed to be able to supply current to all the devices connected to those rails. The large currents and voltage drop in the regulators led to a large power dissipation, which may have led to overheating in some packages.\\

\begin{figure}[htbp]
	\centering
	\begin{subfigure}[b]{0.35\linewidth}
		\includegraphics[width=\linewidth]{parallel ldos.png}
		\caption{Parallel topology}
		\label{fig: parallel ldos}
	\end{subfigure}
	\begin{subfigure}[b]{0.5\linewidth}
		\includegraphics[width=\linewidth]{series ldos.png}
		\caption{Series topology}
		\label{fig: series ldos}
	\end{subfigure}
	\caption{Possible base voltage regulator topologies}
	\label{fig: base ldos}
\end{figure}

The \SI{3.3}{\volt} rail could be created by stepping down either the \SI{12}{\volt} or \SI{5}{\volt} rail (see figure \ref{fig: base ldos}). Both topologies led to the same total conversion loss of \SI{1.14}{\watt}, but the parallel topology was chosen as the \SI{5}{\volt} converter had a smaller output current. This meant that it was less likely to reach the maximum available output current. In order to prevent overheating, the converters were selected to give a maximum temperature rise of \SI{100}{\celsius} when operating at full output current. This meant that the junction to ambient thermal resistance had to be less than \SI{268}{\celsius\per\watt} for the \SI{5}{\volt} converter and \SI{86.2}{\celsius\per\watt} for the \SI{3.3}{\volt} converter. The MCP1702-5002 \cite{mcp1702} in a TO-92 package had a thermal resistance of \SI{131.9}{\celsius\per\watt} and a maximum output current of \SI{250}{\milli\ampere} so was a suitable \SI{5}{\volt} converter. Additionally, it is the same converter used in the remote unit. This component would operate at \SI{60}{\celsius}, so would feel hot but since the maximum operating temperature was \SI{150}{\celsius} then the device would not be damaged. The MCP1755-3302 \cite{mcp1755} in a SOT-223-5 package had a thermal resistance of \SI{62}{\celsius\per\watt}, so would operate at \SI{79}{\celsius} under the worst case load. Again, this was below the maximum operating temperature of \SI{150}{\celsius}. The maximum output current was \SI{300}{\milli\ampere}, which again was above the expected current.\\

It should be noted that the currents given in this section are the worst case currents for all components, as the converters must be designed to provide up to the worst case before failing. In reality, the currents drawn by the components will be much less, especially the digital logic which typically operates with a very low quiescent current, and the communications modules which will not be operating in the on-state all the time. Therefore, the total power consumption will be less than that predicted above, and is estimated to be around \SI{2}{\watt}, with \SI{0.66}{\watt} of this wasted in the voltage regulators.\\




