\section{Hardware Design}

A Peripheral Interface Controller (PIC) was chosen as the microcontroller for both the base and remote unit. PICs are versatile, with highly configurable pin assignments, which was suitable for the different types of sub-system which would be used in the product. Furthermore, they are easy to program in PICBASIC using the MicroCode Studio and MPLAB IDE software packages. PICBASIC provides a high level way to access the PIC's instruction set, with commands available which combine many complex assemble code instructions. The free version of MicroCode Studio limits the range of devices which can be programmed, so the PIC16F688 \cite{pic16f688} was chosen for the remote unit and the PIC18F2550 \cite{pic18f2550} for the base unit. These had the right number of I/O pins for their respective unit, as well as some special features which will be discussed in later sections. PICs are also relatively cheap, which is a good property for the disposable remote unit.\\

\subsection{Measurement System}
\begin{figure}[htbp]
	\centering
	\includegraphics[width=\linewidth]{measurement.PNG}
	\caption{Circuit schematic of diffuse reflectance measurement system}
	\label{fig: measurement schematic}
\end{figure}

Figure \ref{fig: measurement schematic} illustrates the circuit used to perform the backscatter measurements on the liver. Fundamentally, this circuit shines an LED at the liver, then produces an output voltage proportional to the amount of light reflected back. The clinical trials of the original probe \cite{Robertson} used two LEDs, one with a red wavelength (\SI{660}{\nano\metre}) and one with an infra-red wavelength (\SI{850}{\nano\metre}). Two photodiodes were also used, so over all 4 different measurements could be made (with each photodiode-LED combination). The results showed that the correlation with liver PNF did not depend on the wavelength or LED-photodiode spacing, so this was not a critical design requirement of the new probe. Therefore, an LED in the near infra-red (NIR) range was selected (Vishay TSHA4401 \cite{tsha4401} \SI{875}{\nano\metre}) along with a phototransistor also in the NIR range (Vishay BPW85B \cite{bpw85b} \SI{850}{\nano\metre}).\\

The left hand side circuit of figure \ref{fig: measurement system} provides a constant current to the LED. This is essential to ensure the measurements are repeatable, as the brightness of an LED is proportional to its current. The operation of the circuit will now be discussed. First consider the case where MOSFET Q1 has its gate driven low, so it is off. This means that negligible current will flow through the MOSFET, so the op-amp U1A has \SI{2.5}{\volt} at its non-inverting input. Assuming the op-amp is ideal (which means it has infinite gain and input impedance, and zero output impedance), the voltage at the inverting input will also be \SI{2.5}{\volt}. This means there is a constant \SI{2.5}{\volt} across R2, so it draws a constant \SI{11.4}{\milli\ampere}. Because the op-amp is assumed to be ideal, no current can go into the input pins, so the full \SI{11.4}{\milli\ampere} must be sourced from the op-amp output pin and hence pass through the LED D5. This creates a constant current source for the LED, assuming a constant \SI{2.5}{\volt} rail and that the ideal op-amp assumption is valid. When the MOSFET gate is driven high it turns on. This leads to the MOSFET having a very low impedance, so the non-inverting input is effectively tied to ground. Therefore R2 has no volts across it, and hence no current, so the LED turns off.\\

The MCP6002-I/SN \cite{mcp6002} was selected as the op-amp. This has a short circuit output current of \SI{23}{\milli\ampere}, so will comfortably be able to provide the desired \SI{11.4}{\milli\ampere}. Its input offset voltage is $\pm\SI{4.5}{\milli\volt}$, which leads to a potential current error of \SI{20}{\micro\ampere} (or 0.17\%), which is a negligible error. The input voltage noise density is \SI{28}{\nano\volt\per\sqrt{\hertz}} and the gain-bandwidth product is \SI{1}{\mega\hertz} so the worst case bandwidth is \SI{1}{\mega\hertz} (which assumes unity gain). This leads to an input noise voltage of \SI{28}{\micro\volt}, which again is negligible. The current source was tested for its invariance to temperature. When exposed to the heat fro ma hairdryer, the LED current only changed by 0.85\%, so there is confidence that the current source will be stable over the operating temperatures.\\

The light transmitted by the LED is then reflected off the target liver, and the received light is collected by phototransistor Q2. This produces a current proportional to the input light power. A transimpedance amplifier is used convert this to a readable voltage signal. Again assuming op-amp U1B is ideal implies that the voltage at the input pins are equal, and no current enters the pins. The phototransistor current $i_f$ therefore passes through the resistor R3, which leads to an output voltage signal $v_0 = 2.5 - i_fR_f$. The \SI{2.5}{\volt} rail at the non-inverting input acts to bias the op-amp, and was selected as half the voltage rails to ensure that the op-amp output signal could have maximum voltage swing before clipping at the supply rails.\\

\begin{table}[htbp]
	\centering
	\caption{Results for feedback resistor calibration experiments. The peak to peak signal is the difference between the output voltage when the LED was on and off, and the minimum signal is the output voltage when the LED was on.}
	\label{tab: tia feedback resistor}
	\begin{tabular}{|c|c|c|c|}
		\hline
		\textbf{LED Current} & \textbf{Feedback Resistor} & \textbf{Peak to Peak Signal} & \textbf{Minimum Signal}\\
		(mA)	&	(\si{\kilo\ohm})	&	(V)	&	(V)\\
		\hline
		\multirow{4}{*}{10}	&	2.2	&	0.93	&	1.20\\
						\cline{2-4}
						&	3.3	&	1.20	&	1.06\\
						\cline{2-4}
						&	4.7	&	1.60	&	0.62\\
						\cline{2-4}
						&	6.8	&	2.22	&	0.00\\
		\hline
		\multirow{4}{*}{20}	&	1.2	&	0.84	&	1.42\\
						\cline{2-4}
						&	1.5	&	1.07	&	1.15\\
						\cline{2-4}
						&	2.7	&	1.9	&	0.25\\
						\cline{2-4}
						&	3.3	&	2.09	&	0.00\\
		\hline
	\end{tabular}
\end{table}

The feedback resistor $R_f$ needed to be chosen to ensure good output characteristics. If it was too small, then the PIC's ADC would not be able to discriminate between changes in the light intensity.  The PIC16F688 uses a 10-bit ADC, so the maximum voltage resolution is \SI{4.88}{\milli\volt} when operated at \SI{5}{\volt}. The feedback resistor also cannot be too large, as this could lead to the op-amp saturating at the ground supply rail. Table \ref{tab: tia feedback resistor} shows the results of an experiment carried out to investigate the signal levels with different feedback resistors. The circuit was constructed on breadboard, with the LED and phototransistor soldered to stripboard to ensure they remained at a fixed distance of \SI{7.62}{\milli\metre}. This was then shone at a piece of A4 paper at a distance which led to the largest signal. The peak to peak signal is the difference between the transimpedance amplifier output voltage when the LED was on and off, and the minimum signal is the output voltage when the LED was on. Whenever the minimum signal was \SI{0}{\volt}, the amplifier had saturated so these values of $R_f$ are unsuitable. Therefore, the optimum $R_f = \SI{4.7}{\kilo\ohm}$, as this had the largest peak to peak signal without saturating. The system was tested using an LED current of \SI{20}{\milli\ampere} as well, but it was decided that this was too close to the op-amp output current limit to be a reliable, stable current source.\\

%LTSpice simulation

The transimpedance amplifier is a notoriously unstable circuit due to the phototransistor's junction capacitance. This can be stabilised by adding the capacitor C1 \cite{tia_stability}, which adds a zero into the feedback factor, compensating for the pole created by the phototransistor capacitance \cite{tia_stability}. The capacitor value was selected to be \SI{470}{\pico\farad}, as this gave a bandwidth of \SI{72}{\kilo\hertz} which is well above the required bandwidth of the circuit (which is \SI{10}{\kilo\hertz} at most), but is well below the gain-bandwidth product of \SI{1}{\mega\hertz} so it avoids the stability problems.\\

A button also needed to be designed for the probe, so the surgeon could indicate that they wanted to take a measurement. A standard push button could not be used because the remote unit had to be hermetically sealed. Therefore, a non-contact means of sensing a button press had to be devised. This could either be capacitive, sensing the finger like the touch screen on a mobile phone, or optical, by measuring light reflected back from the finger. It was found that the liver backscatter measurement system (figure \ref{fig: measurement schematic}) was discriminated well between the presence or absence of a finger at a range of a few centimetres, so this circuit was included twice within the remote unit to be used as a button. The downside to this method is that it is an active sensing system, requiring power to be supplied to the LED and phototransistor. This will limit the time the remote unit can operate over one full charge. \\



\subsection{Communications}
The Quasar QAM-TX3 \cite{qam-tx} and QAM-RX10-433 \cite{qam-rx} transmitter/receiver modules were used to implement the wireless link. These had all the amplification, demodulation, filtering, and other signal processing required for a radio link fully integrated. Fully integrated modules were selected because they were cheap and simplified the design greatly, as the design only had to focus on low frequencies and not the complex effects associated with RF electronics. The Quasar modules allowed the raw data to be input to the data pin in baseband, then modulated this onto a \SI{433}{\mega\hertz} carrier using on-off keying (OOK). The transmitter then sent this modulated signal to its antenna, and was received by the receiver which demodulated the signal and output the baseband signal at its data pin. The modules could work up to \SI{3}{\kilo\bit\per\second}, which is a suitable speed for the small packets of data which will need to be sent by the remote unit. They operate in the \SI{433}{\mega\hertz} band, which is an unlicensed ISM band in the UK \cite{ism_band} so there should be no regulatory issues using this frequency. A \SI{100}{\pico\farad} decoupling capacitor was used between the power rails of both modules, to smooth out any ripple in the power supply to ensure a reliable RF stage.\\

\subsection{Power and Wireless Charging}
The remote unit was designed to run from a \SI{5}{\volt} supply. \SI{3.3}{\volt} was not suitable as the LEDs had a forward voltage of \SI{1.5}{\volt}, so a \SI{3.3}{\volt} supply would potentially be too small for the current source designed in figure \ref{fig: measurement schematic}. Therefore, a set of batteries had to be selected which would provide this voltage. The batteries had to be small to ensure the overall remote unit design was small enough to fit in the surgeon's hand, and needed to be rechargeable because of the hermetic seal. Two different chemistries were available from RS Components \cite{rs} in a small, rechargeable package: lithium ion (Li-ion) and Nickel Metal Hydride (NiMH). The NiMH chemistry was more suitable due to the increased safety. Li-ion batteries are highly sensitive to over/under-voltage and high temperatures, and can blow up if these limits are exceeded \cite{batteries}. This requires complex protection circuitry and may mean that the battery will not survive being placed in an autoclave. NiMH are much more resilient to over and under charging, so are much safer than Li-ion. They also have a higher energy density \cite{batteries}. Nevertheless, they are lower voltage so more cells will be required to provide the desired \SI{5}{\volt}, have a long charging time, and they have a high self-discharge rate \cite{batteries}. This is not such an issue for this application, as the remote unit can remain charging until it is required for an operation, and then it will only be used for a short time before being placed on charge again. A \SI{2.4}{\volt} \SI{80}{\milli\ampere\hour} RS-Pro NiMH button cell \cite{rs_pro_batteries} was selected as suitable. Three of these were used to give a nominal \SI{7.2}{\volt} supply, which gave a margin of 44\% for when the cells started to discharge.\\

A power converter then needed to be selected to drop the \SI{7.2}{\volt} battery voltage to the required \SI{5}{\volt} rail. A Low-Dropout (LDO) voltage regulator was deemed suitable for this application, as it would provide a stable voltage rail. The advantage over a buck converter is the smaller device size and design simplicity, but this comes at the cost of worse efficiency. The MCP1702T-5002E/CB \cite{mcp1702} in a SOT-23A package was suitable. This was a \SI{5}{\volt} regulator with a rated output current of \SI{250}{\milli\ampere}. This was well above the \SI{50}{\milli\ampere} maximum current required by the remote unit (see section \ref{power budget}). The quiescent current was \SI{2}{\micro\ampere}, which is negligible compared with the remainder of the circuit, so the regulator will not affect the battery lifetime. The regulator will dissipate a maximum of $\SIrange{7.2}{5}{\volt}\times\SI{50}{\milli\ampere}=\SI{110}{\milli\watt}$. The SOT-23A package has a junction to air thermal resistance of \SI{336}{\celsius\per\watt}, so the maximum temperature increase is \SI{37}{\celsius}. In fact, the device will rarely operate at \SI{50}{\milli\ampere}, so the regulator will remain at ambient temperature.\\

\begin{figure}[htbp]
	\centering
	\includegraphics[width=\linewidth]{h bridge charger.PNG}
	\caption{Circuit schematic for H-Bridge inductive wireless charger. The left hand side circuit is included in the base unit, and the right hand side circuit is included in the remote unit.}
	\label{fig: charger schematic}
\end{figure}
	

Inductive charging was selected as an appropriate method of recharging the batteries. This involved placing two air-cored coils in close proximity, applying an AC voltage to the primary and rectifying the voltage across the secondary. Figure \ref{fig: charger schematic} shows the circuit schematic, which uses two PMOS and NMOS pairs in a H-bridge arrangement to generate the AC voltage. The MOSFETs are arranged in a CMOS inverter structure, so when the input gate voltage is high, their output is low, and when the gate is low their output is high. The two half bridges are driven with inverted signals, so the voltage across the load alternates between \SI{\pm 5}{\volt}. The series capacitor is used to create a resonant circuit with the inductor, which increases the voltage across the primary coil and smooths the square wave input voltage waveform to a sinusoid across the inductor. The capacitor is designed to give the circuit a resonant frequency equal to the drive frequency, to get the maximum gain possible. The series resistor is included to limit the current through the circuit. An ideal series LC circuit has zero impedance at resonance, so it will look like a short circuit to the external circuit. The PMOS transistors had a current rating of \SI{230}{\milli\ampere}, so using a series resistance of \SI{22}{\ohm} will limit the current to \SI{227}{\milli\ampere}, with the channel resistance of the MOSFETs and parasitic LC resistances acting to reduce it further.\\

The primary coil will generate an alternating magnetic field due to the sinusoidal voltage across it. This couples with the secondary coil to induce an alternating voltage. The coupling of air-cored transformers is very poor, so a large voltage will be required across the primary coil to ensure the secondary coil receives enough volts. The resonant circuit aids this. The secondary coil's alternating voltage is then rectified to a DC voltage by a diode bridge. The NSR05F20NXT5G Schottky barrier diode \cite{original_diode} was used in the diode bridge. These were chosen because of their very low forward voltage, \SI{0.2}{\volt}, which would make sure that the required secondary voltage was kept as small as possible. A larger diode drop would mean a larger secondary voltage was required, which could cause problems under the low coupling conditions of the air-cored transformer. Their reverse leakage was \SI{2}{\micro\ampere}, which was also good. They were rated to \SI{20}{\volt} and \SI{500}{\milli\ampere}, which were well below the expected operating conditions of \SI{10}{\volt} and \SI{10}{\milli\ampere}. The battery voltage was \SI{7.2}{\volt}, so the total required voltage across the secondary including the two diode drops was \SI{7.6}{\volt}.\\

\begin{figure}[htbp]
	\centering
	\includegraphics[width=\linewidth]{circular coupling.PNG}
	\caption{The experimentally derived coupling coefficient of circular coils as a function of coil separation. 100 turns were used on the primary coil, and 160 turns were used on the secondary coil.}
	\label{fig: circular coupling}
%*******************REPLOT********************
\end{figure}

 

%2.5V rail
%Battery voltage sensor
%Battery current sensor

\subsection{Remote Unit}
%Temperature sensor
%PicKit programmer
%Power budget

\subsection{Base Unit}
%Memory 
%RTC
%LCD
%switches
%power budget